<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航数据管理系统</title>
    <!-- PWA相关配置 -->
    <link rel="manifest" href="../../manifest.json">
    <meta name="theme-color" content="#3e8e41">
    <meta name="description" content="导航页面数据管理工具">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="导航管理">
    <link rel="apple-touch-icon" href="../../img/index.png">
    
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/all.min.css">
    <link href="../../css/manager-styles.css" rel="stylesheet">
    <!-- 引入通用脚本 -->
    <script src="../../js/manager-common.js"></script>
    <style>
        /* 页面特定样式 */
        .site-card {
            width: 100px;
            height: 110px;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            display: inline-block;
            text-align: center;
            cursor: pointer;
        }
        
        .site-card:hover {
            transform: translateY(-2px);
        }
        
        .site-card .delete-corner {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        
        .site-card:hover .delete-corner {
            opacity: 1;
        }
        
        .site-card .site-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            object-fit: cover;
            margin: 0 auto 8px;
            display: block;
        }
        
        .site-card .site-name {
            font-size: 0.75rem;
            font-weight: 500;
            text-overflow: ellipsis;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.2;
            height: 28px;
        }
        
        .json-preview {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f8f9fa;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        
        .page-btn {
            font-size: 0.85rem;
        }
        
        .special-section .badge {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        /* 操作日志按钮样式 */
        .home-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .home-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* 管理页面导航栏中的感叹号按钮样式 */
        .manager-nav-button.bg-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%) !important;
            color: white !important;
        }
        
        .manager-nav-button.bg-warning:hover {
            background: linear-gradient(135deg, #ffb300 0%, #ffa000 100%) !important;
            color: white !important;
        }
        
        /* 日志条目样式 */
        .log-entry {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            font-size: 0.875rem;
        }
        
        .log-entry.success {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        
        .log-entry.error {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        
        .log-entry.warning {
            border-left-color: #ffc107;
            background-color: #fffef0;
        }
        
        .log-entry.info {
            border-left-color: #17a2b8;
            background-color: #f0f9ff;
        }
        
        .log-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .log-message {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .log-details {
            font-size: 0.8rem;
            color: #6c757d;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="manager-body">
    <!-- 返回首页按钮 -->
    <a href="../../index.html" class="home-button bg-dark text-white" title="返回首页">
        <i class="fas fa-home"></i>
    </a>
    
    <!-- 主题切换按钮将由manager-common.js自动创建 -->
    
    <!-- 管理页面导航栏 -->
    <div class="manager-nav">
        <a href="nav-manager.html" class="manager-nav-button active" title="导航数据管理">
            <i class="fas fa-sitemap"></i>
        </a>
        <a href="MM-generator.html" class="manager-nav-button" title="密码生成器">
            <i class="fas fa-key"></i>
        </a>
        <a href="vol-manager.html" class="manager-nav-button" title="版本管理">
            <i class="fas fa-code-branch"></i>
        </a>
        <!-- 操作日志按钮 -->
        <button class="manager-nav-button bg-warning text-white" title="操作日志" data-bs-toggle="offcanvas" data-bs-target="#logOffcanvas">
            <i class="fas fa-exclamation-circle"></i>
        </button>
    </div>
    <div class="manager-header py-4 mb-4">
        <div class="container">
            <h1 class="text-center mb-2">导航数据管理系统</h1>
            <p class="text-center mb-0">管理您的网站导航选项卡内容</p>
        </div>
    </div>
    
    <div class="container container-main">
        <!-- 版本信息 -->
        <div class="version-info p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-2"><i class="fas fa-code-branch me-2"></i>版本信息</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">Web版本: <span id="currentWebVol">-</span></span>
                        <span class="badge bg-light text-dark">数据版本: <span id="currentWebData">-</span></span>
                    </div>
                </div>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#versionModal">
                    <i class="fas fa-edit me-1"></i>编辑版本
                </button>
            </div>
        </div>
        
        <!-- 页面选择器 -->
        <div class="bg-light rounded p-3 mb-4">
            <h5 class="mb-3">选择要管理的页面:</h5>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-primary page-btn active" data-page="index">主页 (index.html)</button>
                <button class="btn btn-outline-primary page-btn" data-page="more">更多页面 (More.html)</button>
                <button class="btn btn-outline-primary page-btn" data-page="dd">DD页面 (DD.html)</button>
                <button class="btn btn-outline-primary page-btn" data-page="download">下载页面 (Download.html)</button>
                <button class="btn btn-outline-primary page-btn" data-page="develop">开发页面 (Develop.html)</button>
            </div>
        </div>
        
        <!-- 功能卡片 -->
        <div class="row mb-4 g-3">
            <div class="col-md-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="text-primary mb-3 feature-icon"><i class="fas fa-file-upload"></i></div>
                        <h5>上传JSON文件</h5>
                        <p class="flex-grow-1">从您的设备上传导航数据JSON文件</p>
                        <button class="btn manager-btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-1"></i>上传JSON
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="text-success mb-3 feature-icon"><i class="fas fa-database"></i></div>
                        <h5>从本地加载</h5>
                        <p class="flex-grow-1">从本地JSON文件加载数据</p>
                        <button id="loadFromLocalBtn" class="btn manager-btn-success mt-2">
                            <i class="fas fa-download me-1"></i>从本地加载
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="text-info mb-3 feature-icon"><i class="fas fa-save"></i></div>
                        <h5>保存数据</h5>
                        <p class="flex-grow-1">将当前数据保存到本地存储并下载JSON文件</p>
                        <button id="saveBtn" class="btn manager-btn-primary mt-2">
                            <i class="fas fa-save me-1"></i>保存数据
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card feature-card h-100">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="text-warning mb-3 feature-icon"><i class="fas fa-trash-alt"></i></div>
                        <h5>清空数据</h5>
                        <p class="flex-grow-1">清除当前已加载的所有导航数据</p>
                        <button id="clearDataBtn" class="btn manager-btn-warning mt-2">
                            <i class="fas fa-broom me-1"></i>清空数据
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 主要管理区域 -->
        <div class="card manager-card mb-4">
            <div class="card-header manager-card-header d-flex justify-content-between align-items-center py-3">
                <span id="currentPageTitle" class="fw-bold">主页 - 导航选项卡管理</span>
                <div>
                    <button id="addTabBtn" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-plus me-1"></i>添加选项卡
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <strong>使用说明：</strong> 您可以在此页面管理导航选项卡和其中的网站链接。修改后请点击"保存数据"按钮。
                </div>
                
                <ul class="nav nav-tabs manager-nav-tabs mb-4" id="navTabs" role="tablist"></ul>
                <div class="tab-content" id="navTabContent"></div>
                
                <!-- 特殊栏目管理区域 -->
                <div id="specialSection">
                    <div class="special-section p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-2"><i class="fas fa-lock me-2"></i>特殊隐藏栏目管理 - 小日本ポートエロ</h5>
                                <div>
                                    <span class="badge me-2">触发代码: 001</span>
                                    <span class="badge">在More页面中默认隐藏</span>
                                </div>
                            </div>
                            <div>
                                <button id="addSpecialSiteBtn" class="btn btn-light btn-sm">
                                    <i class="fas fa-plus me-1"></i>添加网站
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="sites-container mt-3" id="specialSitesContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 页脚 -->
    <div class="manager-footer py-3 mt-4">
        <div class="container text-center">
            <p class="mb-1 text-muted">导航数据管理系统 &copy; 2023 Xiaolan</p>
            <p class="mb-0"><a href="../../index.html" class="text-decoration-none">返回主页</a></p>
        </div>
    </div>
    
    <!-- 全局加载覆盖层 -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">加载中...</div>
    </div>
    
    <!-- 模态框部分保持不变 -->
    <!-- 版本信息编辑模态框 -->
    <div class="modal fade" id="versionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑版本信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="versionForm">
                        <div class="mb-3">
                            <label for="webVol" class="form-label">Web版本 (web_vol)</label>
                            <input type="text" class="form-control" id="webVol" placeholder="例如: 1.2.0" required>
                            <div class="form-text">网站编译版本号</div>
                        </div>
                        <div class="mb-3">
                            <label for="webData" class="form-label">数据版本 (web_data)</label>
                            <input type="text" class="form-control" id="webData" placeholder="例如: 2024.03.15" required>
                            <div class="form-text">列表数据版本号</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn manager-btn-primary" id="saveVersionBtn">保存版本信息</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">上传JSON文件</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <div class="upload-area" id="dropArea">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <h5>拖放JSON文件到这里</h5><p class="text-muted">或者</p>
                    <label for="jsonFile" class="btn manager-btn-primary"><i class="fas fa-folder-open me-1"></i>选择文件</label>
                    <input type="file" id="jsonFile" accept=".json" class="d-none">
                    <div class="mt-3"><small class="text-muted">支持标准的JSON格式文件</small></div>
                </div>
                <!-- 上传进度条 -->
                <div id="uploadProgressContainer" class="d-none mt-3">
                <div class="d-flex justify-content-between items-center mb-1">
                    <p class="mb-1">正在处理：<span id="progressFileName"></span></p>
                    <span id="progressPercentage" class="text-muted small">0%</span>
                </div>
                <div class="progress progress-bar-animation mb-1">
                    <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p id="progressMessage" class="text-sm text-muted">准备中...</p>
            </div>
                <div id="fileInfo" class="d-none">
                    <div class="alert alert-success"><i class="fas fa-check-circle me-2"></i><span id="fileName">已选择文件：</span></div>
                    <h6 class="mt-4">JSON预览：</h6><div class="json-preview" id="jsonPreview"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn manager-btn-primary" id="confirmUpload" disabled>确认上传</button>
            </div>
        </div></div>
    </div>
    <div class="modal fade" id="addSiteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">添加新网站</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <!-- 网站图标显示区域 -->
                <div class="text-center mb-3" id="siteIconPreview">
                    <div id="defaultIcon" class="site-icon-default">
                        <i class="fas fa-globe fa-3x"></i>
                    </div>
                    <img src="" alt="网站图标" id="siteIconImage" class="site-icon img-fluid" style="display: none;">
                    <div id="loadingIcon" class="site-icon-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin fa-3x"></i>
                    </div>
                </div>
                <form id="addSiteForm">
                    <div class="mb-3"><label for="siteName" class="form-label">网站名称</label><input type="text" class="form-control" id="siteName" required></div>
                    <div class="mb-3">
                        <label for="siteUrl" class="form-label">网站地址</label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="siteUrl" required>
                            <button type="button" class="btn btn-outline-secondary" id="clipboardBtn">黏贴</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>图标将自动使用: https://api.afmax.cn/so/ico/index.php?r=网站地址</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn manager-btn-primary" id="confirmAddSite">添加</button>
            </div>
        </div></div>
    </div>
   
        </div></div>
    </div>
    <div class="modal fade" id="editSiteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">编辑网站</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <form id="editSiteForm">
                    <input type="hidden" id="editSiteTabIndex">
                    <input type="hidden" id="editSiteIndex">
                    <div class="mb-3"><label for="editSiteName" class="form-label">网站名称</label><input type="text" class="form-control" id="editSiteName" required></div>
                    <div class="mb-3"><label for="editSiteUrl" class="form-label">网站地址</label><input type="url" class="form-control" id="editSiteUrl" required></div>
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>图标将自动使用: https://api.afmax.cn/so/ico/index.php?r=网站地址</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmEditSite">保存</button>
            </div>
        </div></div>
    </div>
    <div class="modal fade" id="addTabModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">添加新选项卡</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <form id="addTabForm">
                    <div class="mb-3"><label for="tabName" class="form-label">选项卡名称</label><input type="text" class="form-control" id="tabName" required></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddTab">添加</button>
            </div>
        </div></div>
    </div>
    <div class="modal fade" id="confirmClearModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">确认清空数据</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>您确定要清空所有已加载的导航数据吗？此操作不可撤销！
                </div>
                <p class="mt-3">当前页面: <span id="currentPageName">主页</span></p>
                <p>将删除所有选项卡和网站数据</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" id="confirmClear">确认清空</button>
            </div>
        </div></div>
    </div>
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">确认删除</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>您确定要删除这个网站吗？此操作不可撤销！
                </div>
                <p class="mt-3">网站名称: <span id="deleteSiteName"></span></p>
            </div>
            <div class="modal-footer">
                <input type="hidden" id="deleteTabIndex">
                <input type="hidden" id="deleteSiteIndex">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
            </div>
        </div></div>
    </div>
    
    <!-- 操作日志 Offcanvas 组件 -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="logOffcanvas" aria-labelledby="logOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="logOffcanvasLabel">
                <i class="fas fa-history me-2"></i>操作日志
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">系统操作记录</span>
                <button class="btn btn-sm btn-outline-secondary" id="clearLogsBtn">
                    <i class="fas fa-trash me-1"></i>清空日志
                </button>
            </div>
            
            <!-- 日志容器 -->
            <div id="logContainer" class="mb-3"></div>
            <div id="emptyLogMessage" class="text-center text-muted py-3">
                <i class="fas fa-history me-2"></i>暂无操作日志
            </div>
            
            <!-- 新增功能按钮区域 -->
            <div class="mt-4 p-3 bg-light rounded">
                <h6 class="text-muted mb-2"><i class="fas fa-tools me-2"></i>工具功能</h6>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-primary" id="checkUrlBtn">
                        <i class="fas fa-link me-1"></i>检查URL错误
                    </button>
                    <button class="btn btn-sm btn-success" id="checkAccessibilityBtn">
                        <i class="fas fa-check-circle me-1"></i>检查可访问性
                    </button>
                    <button class="btn btn-sm btn-info" id="pingSearchEnginesBtn">
                        <i class="fas fa-network-wired me-1"></i>搜索引擎Ping值
                    </button>
                </div>
                
                <!-- Ping值显示区域 -->
                <div id="pingResults" class="mt-3 p-2 bg-white rounded d-none">
                    <h6 class="text-sm font-medium mb-2">搜索引擎Ping值 (毫秒)</h6>
                    <div class="ping-items"></div>
                </div>
            </div>
            
            <!-- URL错误检查结果显示区域 -->
            <div id="urlErrorsDisplay" class="mt-4 p-3 bg-light rounded d-none">
                <h6 class="text-muted mb-2"><i class="fas fa-exclamation-triangle me-2"></i>URL错误检查结果</h6>
                <div id="urlErrorsContent" class="bg-white p-2 rounded"></div>
            </div>
            
            <!-- URL修复确认模态框 -->
            <div class="modal fade" id="urlFixModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">URL错误检查结果</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="urlCheckResults" class="mb-3"></div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="selectAllUrls">
                                <label class="form-check-label" for="selectAllUrls">全选所有错误</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="confirmFixUrls">确认修复所选</button>
                        </div>
                    </div>
                </div>
            </div>
            

        </div>
    </div>
    
    <script src="../../js/bootstrap.bundle.min.js"></script>
    <script>
        // 初始化剪贴板按钮功能
        function initClipboardButton() {
            const siteUrlInput = document.getElementById('siteUrl');
            const clipboardBtn = document.getElementById('clipboardBtn');
            const siteNameInput = document.getElementById('siteName');
            
            if (!siteUrlInput || !clipboardBtn || !siteNameInput) return;
            
            // 初始化按钮文本
            if (siteUrlInput.value.trim() === '') {
                clipboardBtn.textContent = '黏贴';
            } else {
                clipboardBtn.textContent = '检索';
            }
            
            // 监听输入框实时变化，即时切换按钮文本
            // 注意：此事件仅处理按钮文本切换，不执行其他操作
            siteUrlInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    clipboardBtn.textContent = '黏贴';
                } else {
                    clipboardBtn.textContent = '检索';
                }
            })
            
            // 按钮点击事件
            clipboardBtn.addEventListener('click', async function() {
                if (siteUrlInput.value.trim() === '') {
                    // 粘贴功能
                    try {
                        const text = await navigator.clipboard.readText();
                        siteUrlInput.value = text;
                        // 更新按钮文本
                        clipboardBtn.textContent = '检索';
                        // 如果粘贴的是URL，显示图标
                        if (text.trim().match(/^https?:\/\//i)) {
                            showSiteIcon(text.trim());
                            
                            // 自动获取网站名称
                            if (!siteNameInput.value.trim()) {
                                try {
                                    const siteName = await extractSiteNameFromUrl(text.trim());
                                    if (siteName) {
                                        siteNameInput.value = siteName;
                                        addLogEntry('粘贴后自动获取网站名称成功', LOG_TYPES.INFO, `URL: ${text.trim()}, 获取的网站名称: ${siteName}`);
                                    }
                                } catch (error) {
                                    console.error('粘贴后自动获取网站名称失败:', error);
                                }
                            }
                        }
                    } catch (err) {
                        showAlert('无法读取剪贴板内容，请手动粘贴', 'error');
                        addLogEntry('剪贴板读取失败', LOG_TYPES.ERROR, err.message);
                    }
                } else {
                    // 检索功能
                    const url = siteUrlInput.value.trim();
                    
                    // 显示加载状态
                    clipboardBtn.disabled = true;
                    clipboardBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检索中...';
                    
                    // 显示网站图标
                    showSiteIcon(url);
                    
                    try {
                        // 异步获取网站名称
                        const siteName = await extractSiteNameFromUrl(url);
                        
                        if (siteName) {
                            siteNameInput.value = siteName;
                            showAlert('已自动填充网站名称', 'success');
                            // 记录检索成功日志
                            addLogEntry('网站名称检索成功', LOG_TYPES.SUCCESS, `URL: ${url}, 提取的网站名称: ${siteName}`);
                        } else {
                            showAlert('无法自动识别网站名称，请手动输入', 'info');
                            // 记录检索失败日志
                            addLogEntry('网站名称检索失败', LOG_TYPES.INFO, `URL: ${url}`);
                        }
                    } catch (error) {
                        showAlert('获取网站名称时出错', 'error');
                        addLogEntry('网站名称检索异常', LOG_TYPES.ERROR, `URL: ${url}, 错误: ${error.message}`);
                    } finally {
                        // 恢复按钮状态
                        clipboardBtn.disabled = false;
                        clipboardBtn.textContent = '检索';
                    }
                }
            });
            
            // 监听URL输入变化，自动显示图标和获取网站名称
            // 注意：此功能与粘贴功能和按钮点击功能有部分重叠，但保留以提供更完整的用户体验
            siteUrlInput.addEventListener('change', async function() {
                const url = this.value.trim();
                if (url && url.match(/^https?:\/\//i)) {
                    // 显示网站图标
                    showSiteIcon(url);
                    
                    // 如果网站名称输入框为空，自动获取网站名称
                    if (!siteNameInput.value.trim()) {
                        try {
                            const siteName = await extractSiteNameFromUrl(url);
                            if (siteName) {
                                siteNameInput.value = siteName;
                                // 记录自动获取成功日志
                                addLogEntry('自动获取网站名称成功', LOG_TYPES.INFO, `URL: ${url}, 获取的网站名称: ${siteName}`);
                            }
                        } catch (error) {
                            console.error('自动获取网站名称失败:', error);
                        }
                    }
                }
            });
        }
        
        // 从网络获取网站标题
        async function fetchWebsiteTitle(url) {
            try {
                // 使用公共CORS代理服务获取网站HTML内容
                // 注意：这是一个示例代理，实际使用时可能需要更换为可靠的代理服务
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    timeout: 5000, // 设置5秒超时
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                
                // 尝试从HTML中提取title标签内容
                const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
                if (titleMatch && titleMatch[1]) {
                    // 清理标题文本
                    return titleMatch[1].trim().replace(/[\t\n\r]+/g, ' ');
                }
                
                return null; // 未找到标题
            } catch (error) {
                console.error('获取网站标题失败:', error);
                return null; // 获取失败
            }
        }
        
        // 从URL提取网站名称（优先从网络获取标题，失败则使用域名解析）
        async function extractSiteNameFromUrl(url) {
            // 首先尝试从网络获取网站标题
            const title = await fetchWebsiteTitle(url);
            if (title) {
                // 如果标题过长，进行适当截断
                if (title.length > 30) {
                    return title.substring(0, 30) + '...';
                }
                return title;
            }
            
            // 如果网络获取失败，回退到现有的域名解析方法
            try {
                // 创建URL对象
                const urlObj = new URL(url);
                // 获取主机名并移除www.前缀
                let hostname = urlObj.hostname;
                if (hostname.startsWith('www.')) {
                    hostname = hostname.substring(4);
                }
                // 分割域名，取主要部分
                const parts = hostname.split('.');
                if (parts.length >= 2) {
                    // 对于.com.cn等多级域名，取倒数第三部分
                    if (parts.length >= 3 && (parts[parts.length-1] === 'cn' || parts[parts.length-1] === 'net' || parts[parts.length-1] === 'org')) {
                        return parts[parts.length-3];
                    }
                    // 其他情况取倒数第二部分
                    return parts[parts.length-2];
                }
                return hostname;
            } catch (e) {
                // 如果URL格式不正确，尝试简单处理
                let cleanUrl = url.trim();
                // 移除协议
                cleanUrl = cleanUrl.replace(/^https?:\/\//, '');
                // 移除路径
                cleanUrl = cleanUrl.split('/')[0];
                // 移除www.
                cleanUrl = cleanUrl.replace(/^www\./, '');
                // 分割域名
                const parts = cleanUrl.split('.');
                if (parts.length >= 2) {
                    return parts[0];
                }
                return cleanUrl;
            }
        }
        
        // 在模态框显示时初始化
        document.addEventListener('DOMContentLoaded', function() {
            const addSiteModal = document.getElementById('addSiteModal');
            if (addSiteModal) {
                addSiteModal.addEventListener('shown.bs.modal', function() {
                    // 延迟一下确保DOM元素已加载
                    setTimeout(() => {
                        // 重置图标显示状态
                        const siteIconPreview = document.getElementById('siteIconPreview');
                        const siteIconImage = document.getElementById('siteIconImage');
                        const defaultIcon = document.getElementById('defaultIcon');
                        const loadingIcon = document.getElementById('loadingIcon');
                        
                        if (siteIconPreview && siteIconImage && defaultIcon && loadingIcon) {
                            defaultIcon.style.display = 'block';
                            siteIconImage.style.display = 'none';
                            loadingIcon.style.display = 'none';
                        }
                        
                        initClipboardButton();
                        // 初始化按钮文本
                        const siteUrlInput = document.getElementById('siteUrl');
                        const clipboardBtn = document.getElementById('clipboardBtn');
                        if (siteUrlInput && clipboardBtn) {
                            if (siteUrlInput.value.trim() === '') {
                                clipboardBtn.textContent = '黏贴';
                            } else {
                                clipboardBtn.textContent = '检索';
                            }
                        }
                    }, 100);
                });
            }
        });
        
        // 图标前缀常量
        const ICON_PREFIX = 'https://api.afmax.cn/so/ico/index.php?r=';
        
        // 显示网站图标
        function showSiteIcon(url) {
            const siteIconPreview = document.getElementById('siteIconPreview');
            const siteIconImage = document.getElementById('siteIconImage');
            const defaultIcon = document.getElementById('defaultIcon');
            const loadingIcon = document.getElementById('loadingIcon');
            
            if (siteIconPreview && siteIconImage && defaultIcon && loadingIcon) {
                // 显示加载图标
                defaultIcon.style.display = 'none';
                siteIconImage.style.display = 'none';
                loadingIcon.style.display = 'block';
                
                const iconUrl = ICON_PREFIX + encodeURIComponent(url);
                
                // 创建新图片对象来处理加载状态
                const img = new Image();
                img.src = iconUrl;
                
                img.onload = function() {
                    // 加载成功，显示图标
                    siteIconImage.src = iconUrl;
                    loadingIcon.style.display = 'none';
                    siteIconImage.style.display = 'block';
                };
                
                img.onerror = function() {
                    // 加载失败，显示默认图标
                    siteIconImage.src = '../../img/index.png';
                    loadingIcon.style.display = 'none';
                    siteIconImage.style.display = 'block';
                };
            }
        }
        
        let navData = {
            version: {
                web_vol: "1.0.0",
                web_data: "2024.01.01"
            }
        };
        let currentTabIndex = 0;
        let currentPage = 'index';
        
        // 全局变量存储需要修复的URL错误信息
        let urlErrorsToFix = [];
        
        // 操作日志数组
        let operationLogs = [];
        
        // 日志类型常量
        const LOG_TYPES = {
            SUCCESS: 'success',
            ERROR: 'error',
            WARNING: 'warning',
            INFO: 'info'
        };
        const navTabs = document.getElementById('navTabs');
        const navTabContent = document.getElementById('navTabContent');
        const saveBtn = document.getElementById('saveBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const logContainer = document.getElementById('logContainer');
        const emptyLogMessage = document.getElementById('emptyLogMessage');
        const addTabBtn = document.getElementById('addTabBtn');
        const loadFromLocalBtn = document.getElementById('loadFromLocalBtn');
        const pageTitle = document.getElementById('currentPageTitle');
        const pageButtons = document.querySelectorAll('.page-btn');
        const currentWebVol = document.getElementById('currentWebVol');
        const currentWebData = document.getElementById('currentWebData');
        const saveVersionBtn = document.getElementById('saveVersionBtn');
        const versionModal = new bootstrap.Modal(document.getElementById('versionModal'));
        const specialSection = document.getElementById('specialSection');
        const addSpecialSiteBtn = document.getElementById('addSpecialSiteBtn');
        const specialSitesContainer = document.getElementById('specialSitesContainer');

        // 其他变量声明
        const addSiteModal = new bootstrap.Modal(document.getElementById('addSiteModal'));
        const editSiteModal = new bootstrap.Modal(document.getElementById('editSiteModal'));
        const addTabModal = new bootstrap.Modal(document.getElementById('addTabModal'));
        const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        const confirmAddSite = document.getElementById('confirmAddSite');
        const confirmAddTab = document.getElementById('confirmAddTab');
        const confirmEditSite = document.getElementById('confirmEditSite');
        const confirmUpload = document.getElementById('confirmUpload');
        const jsonFileInput = document.getElementById('jsonFile');
        const dropArea = document.getElementById('dropArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const jsonPreview = document.getElementById('jsonPreview');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const confirmClearModal = new bootstrap.Modal(document.getElementById('confirmClearModal'));
        const confirmClearBtn = document.getElementById('confirmClear');
        const currentPageName = document.getElementById('currentPageName');
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const deleteSiteName = document.getElementById('deleteSiteName');
        
        // 数据修改状态标志
        let dataHasChanged = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // 页面加载时尝试从本地JSON文件加载数据
            loadFromJsonFile();
            setupEventListeners();
            updateVersionDisplay();
        });
        
        function setupEventListeners() {
            saveBtn.addEventListener('click', saveNavData);
            // 移除直接绑定的点击事件，改用setupAddTabButton中设置的新交互
            loadFromLocalBtn.addEventListener('click', loadFromJsonFile);
            confirmAddSite.addEventListener('click', addNewSite);
            // 保留confirmAddTab的事件监听器以兼容旧代码
            confirmAddTab.addEventListener('click', addNewTab);
            confirmUpload.addEventListener('click', processUploadedFile);
            clearDataBtn.addEventListener('click', showClearConfirmModal);
            confirmClearBtn.addEventListener('click', clearAllData);
            confirmEditSite.addEventListener('click', saveEditedSite);
            confirmDeleteBtn.addEventListener('click', deleteSite);
            saveVersionBtn.addEventListener('click', saveVersionInfo);
            
            // 日志管理
            clearLogsBtn.addEventListener('click', clearAllLogs);
            
            // 初始化添加选项卡按钮的新交互
            setupAddTabButton();
            
            // 添加拖拽相关的CSS样式
            addDragDropStyles();
            
            // 初始化数据更新标识
            updateDataChangeIndicator();
        }
        
        // 绑定新功能按钮事件
        const checkUrlBtn = document.getElementById('checkUrlBtn');
        const checkAccessibilityBtn = document.getElementById('checkAccessibilityBtn');
        const pingSearchEnginesBtn = document.getElementById('pingSearchEnginesBtn');
        const selectAllUrls = document.getElementById('selectAllUrls');
        const confirmFixUrls = document.getElementById('confirmFixUrls');
        const pingResults = document.getElementById('pingResults');
        const urlFixModal = new bootstrap.Modal(document.getElementById('urlFixModal'));
        
        if (checkUrlBtn) {
            checkUrlBtn.addEventListener('click', checkUrlErrors);
        }
        
        if (checkAccessibilityBtn) {
            checkAccessibilityBtn.addEventListener('click', checkWebsitesAccessibility);
        }
        
        if (pingSearchEnginesBtn) {
            pingSearchEnginesBtn.addEventListener('click', pingSearchEngines);
        }
        
        if (selectAllUrls) {
            selectAllUrls.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#urlCheckResults input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }
        
        if (confirmFixUrls) {
            confirmFixUrls.addEventListener('click', applyUrlFixes);
        }
            
            // 特殊栏目管理
            addSpecialSiteBtn.addEventListener('click', showAddSpecialSiteModal);
            
            // 版本信息编辑
            document.querySelector('.version-info .btn').addEventListener('click', function() {
                document.getElementById('webVol').value = navData.version.web_vol;
                document.getElementById('webData').value = navData.version.web_data;
            });
            
            pageButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    pageButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPage = this.getAttribute('data-page');
                    updatePageTitle();
                    updateSpecialSectionVisibility();
                    renderTabs();
                });
            });
            
            jsonFileInput.addEventListener('change', handleFileSelect);
            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();e.stopPropagation();
                dropArea.style.borderColor = '#6a11cb';
                dropArea.style.backgroundColor = '#e9ecef';
            });
            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();e.stopPropagation();
                dropArea.style.borderColor = '#dee2e6';
                dropArea.style.backgroundColor = '#f8f9fa';
            });
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();e.stopPropagation();
                dropArea.style.borderColor = '#dee2e6';
                dropArea.style.backgroundColor = '#f8f9fa';
                const files = e.dataTransfer.files;
                if (files.length && files[0].type === 'application/json') {
                    jsonFileInput.files = files;
                    handleFileSelect(e);
                } else {
                    alert('请拖放有效的JSON文件');
                }
            });
        
        
        function updatePageTitle() {
            const titles = {
                'index': '主页 - 导航选项卡管理',
                'more': '更多页面 - 导航选项卡管理', 
                'dd': 'DD页面 - 导航选项卡管理',
                'download': '下载页面 - 导航选项卡管理',
                'develop': '开发页面 - 导航选项卡管理'
            };
            pageTitle.textContent = titles[currentPage] || '导航选项卡管理';
        }
        
        function updateSpecialSectionVisibility() {
            if (currentPage === 'more') {
                specialSection.style.display = 'block';
            } else {
                specialSection.style.display = 'none';
            }
        }
        
        function updateVersionDisplay() {
            if (navData.version) {
                currentWebVol.textContent = navData.version.web_vol;
                currentWebData.textContent = navData.version.web_data;
            }
        }
        
        function saveVersionInfo() {
            const webVol = document.getElementById('webVol').value.trim();
            const webData = document.getElementById('webData').value.trim();
            
            if (!webVol || !webData) {
                alert('请填写所有版本字段');
                return;
            }
            
            // 确保version对象存在
            if (!navData.version) {
                navData.version = {};
            }
            
            navData.version.web_vol = webVol;
            navData.version.web_data = webData;
            
            versionModal.hide();
            updateVersionDisplay();
            showAlert('版本信息已更新', 'success');
        }
        

        
        function showClearConfirmModal() {
            currentPageName.textContent = getPageDisplayName(currentPage);
            confirmClearModal.show();
        }
        
        function getPageDisplayName(page) {
            const names = {
                'index': '主页',
                'more': '更多页面',
                'dd': 'DD页面', 
                'download': '下载页面',
                'develop': '开发页面'
            };
            return names[page] || page;
        }
        
        function clearAllData() {
            if (navData[currentPage]) {
                navData[currentPage] = { tabs: [] };
                showAlert('已清空 ' + getPageDisplayName(currentPage) + ' 的数据', 'success');
                renderTabs();
            } else {
                showAlert('当前页面没有数据可清空', 'warning');
            }
            confirmClearModal.hide();
        }
        
        function handleFileSelect(event) {
            const file = jsonFileInput.files[0];
            if (!file) return;
            
            // 显示进度条
              const progressContainer = document.getElementById('uploadProgressContainer');
              const progressBar = document.getElementById('uploadProgressBar');
              const progressFileName = document.getElementById('progressFileName');
              const progressPercentage = document.getElementById('progressPercentage');
              const progressMessage = document.getElementById('progressMessage');
              
              // 更新进度条的辅助函数
              function updateProgressBar(percent, message) {
                  progressBar.style.width = `${percent}%`;
                  progressBar.setAttribute('aria-valuenow', percent);
                  progressPercentage.textContent = `${percent}%`;
                  progressMessage.textContent = message;
              }
              
              progressContainer.classList.remove('d-none');
              progressFileName.textContent = file.name;
              updateProgressBar(0, '准备中...');
            
            if (file.type !== 'application/json') {
                showAlert('请选择JSON文件', 'danger');
                progressContainer.classList.add('d-none');
                addLogEntry('上传文件类型错误', LOG_TYPES.ERROR, `文件名: ${file.name}, 类型: ${file.type}`);
                return;
            }
            
            fileName.textContent = `已选择文件：${file.name}`;
            fileInfo.classList.remove('d-none');
            
            // 记录日志
            addLogEntry('开始处理上传文件', LOG_TYPES.INFO, `文件名: ${file.name}, 大小: ${(file.size / 1024).toFixed(2)} KB`);
            
            // 模拟初始进度
            setTimeout(() => {
                updateProgressBar(30, '正在验证文件格式...');
            }, 100);
            
            const reader = new FileReader();
            reader.onloadstart = function() {
                updateProgressBar(50, '正在解析JSON数据...');
            };
            
            reader.onload = function(e) {
                try {
                    updateProgressBar(70, '正在验证数据结构...');
                    
                    const content = e.target.result;
                    const jsonData = JSON.parse(content);
                    
                    // 验证JSON结构并确保版本信息存在
                    if (!jsonData.version) {
                        jsonData.version = {
                            web_vol: jsonData.version?.web_vol || "1.0.0",
                            web_data: jsonData.version?.web_data || new Date().toISOString().split('T')[0].replace(/-/g, '.')
                        };
                    }
                    
                    // 验证必要的数据结构
                    if (!jsonData.index || typeof jsonData.index !== 'object') {
                        throw new Error('JSON数据必须包含index对象');
                    }
                    
                    updateProgressBar(90, '准备完成，等待确认...');
                    
                    jsonPreview.textContent = JSON.stringify(jsonData, null, 2);
                    confirmUpload.disabled = false;
                    window.uploadedData = jsonData;
                    
                    updateProgressBar(100, '处理完成！');
                    
                    addLogEntry('文件处理完成', LOG_TYPES.SUCCESS, `文件名: ${file.name}`);
                } catch (e) {
                    jsonPreview.textContent = `错误：${e.message}`;
                    showAlert(`文件解析失败: ${e.message}`, 'danger');
                    addLogEntry('文件解析失败', LOG_TYPES.ERROR, `错误: ${e.message}`);
                    progressContainer.classList.add('d-none');
                    confirmUpload.disabled = true;
                    updateProgressBar(0, '准备中...');
                }
            };
            reader.readAsText(file);
        }
        
        function processUploadedFile() {
            try {
                // 显示全局加载动画
                showLoadingOverlay('正在导入数据...');
                
                if (!window.uploadedData) {
                    showAlert('没有待上传的数据', 'warning');
                    addLogEntry('上传失败', LOG_TYPES.WARNING, '没有待上传的数据');
                    hideLoadingOverlay();
                    return;
                }
                
                // 验证数据完整性
                if (!validateNavData(window.uploadedData)) {
                    showAlert('数据结构验证失败，请检查文件格式', 'danger');
                    addLogEntry('数据验证失败', LOG_TYPES.ERROR, '数据结构不符合要求');
                    hideLoadingOverlay();
                    return;
                }
                
                navData = window.uploadedData;
                updateVersionDisplay();
                renderTabs();
                renderSpecialSites();
                updateSpecialSectionVisibility();
                
                // 隐藏进度条
                document.getElementById('uploadProgressContainer').classList.add('d-none');
                
                // 重置文件输入
                jsonFileInput.value = '';
                fileInfo.classList.add('d-none');
                confirmUpload.disabled = true;
                
                // 初始化拖拽功能
                setTimeout(() => {
                    initSiteDragAndDrop();
                    initTabDragAndDrop();
                    
                    // 隐藏模态框和加载动画
                    uploadModal.hide();
                    hideLoadingOverlay();
                    
                    showAlert('JSON文件已成功上传并加载', 'success');
                    addLogEntry('JSON文件导入成功', LOG_TYPES.SUCCESS, `版本: ${navData.version?.web_vol || '未知'}`);
                    // 显示上传标识
                    showDataSourceIndicator('upload');
                    delete window.uploadedData;
                }, 500);
            } catch (error) {
                hideLoadingOverlay();
                showAlert(`上传过程中发生错误: ${error.message}`, 'danger');
                addLogEntry('上传过程出错', LOG_TYPES.ERROR, `错误: ${error.message}`);
                console.error('上传处理错误:', error);
            }
        }
        
        function renderTabs() {
            navTabs.innerHTML = '';
            navTabContent.innerHTML = '';
            
            if (!navData[currentPage] || !navData[currentPage].tabs || navData[currentPage].tabs.length === 0) {
                navTabContent.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>'+getPageDisplayName(currentPage)+'中没有导航数据</p><button class="btn btn-primary mt-2" id="addFirstTab"><i class="fas fa-plus me-1"></i>添加第一个选项卡</button></div>';
                document.getElementById('addFirstTab').addEventListener('click', showAddTabModal);
                return;
            }
            
            navData[currentPage].tabs.forEach((tab, index) => {
                const tabNav = document.createElement('li');
                tabNav.className = 'nav-item';
                tabNav.setAttribute('draggable', 'true');
                tabNav.setAttribute('data-drag-type', 'tab');
                tabNav.setAttribute('data-tab-index', index);
                const tabLink = document.createElement('a');
                tabLink.className = 'nav-link ' + (index === 0 ? 'active' : '');
                tabLink.id = 'tab-' + index + '-nav';
                tabLink.setAttribute('data-bs-toggle', 'tab');
                tabLink.href = '#tab-' + index;
                tabLink.setAttribute('role', 'tab');
                tabLink.setAttribute('aria-controls', 'tab-' + index);
                tabLink.setAttribute('aria-selected', (index === 0 ? 'true' : 'false'));
                tabLink.textContent = tab.name;
                
                // 添加双击编辑功能
                tabLink.addEventListener('dblclick', function(e) {
                    e.preventDefault(); // 阻止默认的选项卡切换行为
                    
                    // 创建输入框
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = tab.name;
                    input.className = 'form-control form-control-sm tab-name-input';
                    input.style.width = 'auto';
                    input.style.minWidth = '100px';
                    input.style.maxWidth = '200px';
                    input.style.display = 'inline-block';
                    input.style.margin = '0';
                    input.style.padding = '0.25rem 0.5rem';
                    input.style.fontSize = '0.875rem';
                    input.style.lineHeight = '1.5';
                    input.style.borderRadius = '0.2rem';
                    
                    // 保存原始内容和元素
                    const originalContent = tabLink.textContent;
                    
                    // 替换文本为输入框
                    tabLink.innerHTML = '';
                    tabLink.appendChild(input);
                    input.focus();
                    
                    // 处理Enter键保存
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            const newName = input.value.trim();
                            if (newName && newName !== originalContent) {
                                // 更新数据
                                navData[currentPage].tabs[index].name = newName;
                                // 更新显示
                                tabLink.textContent = newName;
                                // 更新选项卡内容区域的标题
                                const tabContentTitle = document.querySelector(`#tab-${index} h5`);
                                if (tabContentTitle) {
                                    tabContentTitle.textContent = newName + ' 选项卡中的网站';
                                }
                                // 添加日志
                                addLogEntry(`已更新选项卡名称: ${originalContent} -> ${newName}`, LOG_TYPES.SUCCESS);
                                showAlert(`选项卡名称已更新: ${originalContent} -> ${newName}`, 'success');
                            } else if (!newName) {
                                // 如果输入为空，恢复原始名称
                                tabLink.textContent = originalContent;
                            }
                        } else if (e.key === 'Escape') {
                            // 按下Esc键取消编辑
                            tabLink.textContent = originalContent;
                        }
                    });
                    
                    // 处理失焦事件
                    input.addEventListener('blur', function() {
                        const newName = input.value.trim();
                        if (newName && newName !== originalContent) {
                            // 更新数据
                            navData[currentPage].tabs[index].name = newName;
                            // 更新显示
                            tabLink.textContent = newName;
                            // 更新选项卡内容区域的标题
                            const tabContentTitle = document.querySelector(`#tab-${index} h5`);
                            if (tabContentTitle) {
                                tabContentTitle.textContent = newName + ' 选项卡中的网站';
                            }
                            // 添加日志
                            addLogEntry(`已更新选项卡名称: ${originalContent} -> ${newName}`, LOG_TYPES.SUCCESS);
                            showAlert(`选项卡名称已更新: ${originalContent} -> ${newName}`, 'success');
                        } else {
                            // 恢复原始名称
                            tabLink.textContent = originalContent;
                        }
                    });
                });
                
                tabNav.appendChild(tabLink);
                navTabs.appendChild(tabNav);
                
                const tabContent = document.createElement('div');
                tabContent.className = 'tab-pane fade '+(index === 0 ? 'show active' : '');
                tabContent.id = 'tab-'+index;
                tabContent.setAttribute('role', 'tabpanel');
                tabContent.innerHTML = '<div class="d-flex justify-content-between align-items-center mb-3"><h5>'+tab.name+' 选项卡中的网站</h5><button class="btn btn-sm btn-primary add-site-btn" data-tab-index="'+index+'"><i class="fas fa-plus me-1"></i>添加网站</button></div><div class="sites-container" id="sites-container-'+index+'">'+renderSites(tab.items, index)+'</div>';
                navTabContent.appendChild(tabContent);
            });
            
            // 绑定添加网站按钮事件
            document.querySelectorAll('.add-site-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentTabIndex = parseInt(this.getAttribute('data-tab-index'));
                    document.getElementById('addSiteForm').reset();
                    document.getElementById('addSiteModal').style.display = 'block';
                });
            });
            
            // 初始化选项卡拖拽功能
            initTabDragAndDrop();
        }
        
        // 初始化选项卡拖拽排序功能
        function initTabDragAndDrop() {
            // 为选项卡容器添加拖放事件
            navTabs.addEventListener('dragover', handleTabDragOver);
            navTabs.addEventListener('drop', handleTabDrop);
            navTabs.addEventListener('dragleave', handleTabDragLeave);
            
            // 为所有选项卡添加拖拽事件
            document.querySelectorAll('.nav-item[data-drag-type="tab"]').forEach(tab => {
                tab.addEventListener('dragstart', handleTabDragStart);
                tab.addEventListener('dragend', handleTabDragEnd);
                tab.addEventListener('dragenter', handleTabDragEnter);
            });
        }
        
        // 处理选项卡拖拽开始
        function handleTabDragStart(e) {
            // 添加拖拽样式
            this.classList.add('dragging');
            
            // 创建拖拽时的视觉指示器
            const dragImage = this.cloneNode(true);
            dragImage.style.position = 'absolute';
            dragImage.style.left = '-9999px';
            dragImage.style.top = '-9999px';
            dragImage.style.opacity = '0.8';
            dragImage.style.width = this.offsetWidth + 'px';
            document.body.appendChild(dragImage);
            
            // 设置拖拽图像
            e.dataTransfer.setDragImage(dragImage, this.offsetWidth / 2, this.offsetHeight / 2);
            
            // 设置拖拽数据
            const tabIndex = this.getAttribute('data-tab-index');
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: 'tab',
                tabIndex: parseInt(tabIndex)
            }));
            
            // 添加动画类
            this.classList.add('drag-start');
        }
        
        // 处理选项卡拖拽结束
        function handleTabDragEnd() {
            // 移除所有拖拽相关样式
            document.querySelectorAll('.nav-item.dragging, .nav-item.drag-over, .nav-item.drag-start').forEach(el => {
                el.classList.remove('dragging', 'drag-over', 'drag-start');
            });
            
            // 移除拖拽占位符
            const placeholder = document.getElementById('tab-placeholder');
            if (placeholder) placeholder.remove();
            
            // 移除拖拽图像
            document.querySelectorAll('[style*="left: -9999px"]').forEach(el => {
                if (el.parentNode === document.body) el.remove();
            });
        }
        
        // 处理选项卡拖拽进入
        function handleTabDragEnter(e) {
            e.preventDefault();
            // 只在拖拽的是选项卡时添加样式
            if (e.dataTransfer.getData('text/plain')) {
                try {
                    const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (dragData.type === 'tab') {
                        this.classList.add('drag-over');
                        
                        // 创建并移动占位符
                        let placeholder = document.getElementById('tab-placeholder');
                        if (!placeholder) {
                            placeholder = document.createElement('li');
                            placeholder.id = 'tab-placeholder';
                            placeholder.className = 'nav-item tab-placeholder';
                            placeholder.style.height = this.offsetHeight + 'px';
                            placeholder.style.width = this.offsetWidth + 'px';
                            placeholder.style.opacity = '0.7';
                            placeholder.style.backgroundColor = '#0d6efd';
                            placeholder.style.margin = this.style.margin;
                            placeholder.style.borderRadius = '0.375rem';
                        }
                        
                        // 插入占位符到当前元素位置
                        this.parentNode.insertBefore(placeholder, this);
                    }
                } catch (error) {
                    // 忽略数据解析错误
                }
            }
        }
        
        // 处理选项卡拖拽悬停
        function handleTabDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        // 处理选项卡拖拽离开
        function handleTabDragLeave(e) {
            // 检查是否真的离开了容器
            const relatedTarget = e.relatedTarget;
            if (!navTabs.contains(relatedTarget)) {
                document.querySelectorAll('.nav-item.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            }
        }
        
        // 处理选项卡放置
        function handleTabDrop(e) {
            e.preventDefault();
            
            try {
                // 获取拖拽数据
                const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                
                if (dragData.type === 'tab') {
                    // 获取目标位置信息
                    const targetElement = e.target.closest('.nav-item[data-drag-type="tab"]');
                    
                    if (targetElement && targetElement !== e.currentTarget) {
                        const targetTabIndex = parseInt(targetElement.getAttribute('data-tab-index'));
                        
                        // 执行拖拽排序
                        reorderTabs(dragData.tabIndex, targetTabIndex);
                        
                        // 显示成功提示
                        showToast('选项卡排序成功', 'success');
                        
                        // 记录用户操作日志
                        logUserAction('reorder_tabs', {
                            fromIndex: dragData.tabIndex,
                            toIndex: targetTabIndex
                        });
                    }
                }
            } catch (error) {
                console.error('选项卡拖拽处理失败:', error);
                showToast('重新排序失败', 'error');
            } finally {
                // 清理拖拽样式
                handleTabDragEnd();
            }
        }
        
        // 重新排序选项卡
        function reorderTabs(fromIndex, toIndex) {
            const tabs = navData[currentPage].tabs;
            
            // 从原位置移除
            const [movedTab] = tabs.splice(fromIndex, 1);
            
            // 插入到新位置
            tabs.splice(toIndex, 0, movedTab);
            
            // 标记数据已修改
            setDataChanged();
            
            // 重新渲染所有选项卡
            renderTabs();
            
            // 记录日志
            addLogEntry(`重新排序选项卡: ${movedTab.name}`, LOG_TYPES.SUCCESS);
        }
        
        // 初始化网站拖拽排序功能
        function initSiteDragAndDrop() {
            // 为所有站点容器添加拖放事件
            document.querySelectorAll('.sites-container').forEach(container => {
                container.addEventListener('dragover', handleSiteDragOver);
                container.addEventListener('drop', handleSiteDrop);
                container.addEventListener('dragleave', handleSiteDragLeave);
            });
            
            // 为所有网站卡片添加拖拽事件
            document.querySelectorAll('.site-card').forEach(card => {
                card.addEventListener('dragstart', handleSiteDragStart);
                card.addEventListener('dragend', handleSiteDragEnd);
                card.addEventListener('dragenter', handleSiteDragEnter);
            });
        }
        
        // 处理网站拖拽开始
        function handleSiteDragStart(e) {
            // 添加拖拽样式
            this.classList.add('dragging');
            
            // 创建拖拽时的视觉指示器
            const dragImage = this.cloneNode(true);
            dragImage.style.position = 'absolute';
            dragImage.style.left = '-9999px';
            dragImage.style.top = '-9999px';
            dragImage.style.opacity = '0.8';
            dragImage.style.width = this.offsetWidth + 'px';
            document.body.appendChild(dragImage);
            
            // 设置拖拽图像
            e.dataTransfer.setDragImage(dragImage, this.offsetWidth / 2, this.offsetHeight / 2);
            
            // 设置拖拽数据
            const tabIndex = this.getAttribute('data-tab-index');
            const siteIndex = this.getAttribute('data-site-index');
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: 'site',
                tabIndex: parseInt(tabIndex),
                siteIndex: parseInt(siteIndex)
            }));
            
            // 添加动画类
            this.classList.add('drag-start');
        }
        
        // 处理网站拖拽结束
        function handleSiteDragEnd() {
            // 移除所有拖拽相关样式
            document.querySelectorAll('.site-card.dragging, .site-card.drag-over, .site-card.drag-start').forEach(el => {
                el.classList.remove('dragging', 'drag-over', 'drag-start');
            });
            
            // 移除拖拽占位符
            const placeholder = document.getElementById('site-placeholder');
            if (placeholder) placeholder.remove();
            
            // 移除拖拽图像
            document.querySelectorAll('[style*="left: -9999px"]').forEach(el => {
                if (el.parentNode === document.body) el.remove();
            });
        }
        
        // 处理网站拖拽进入
        function handleSiteDragEnter(e) {
            e.preventDefault();
            // 只在拖拽的是网站时添加样式
            if (e.dataTransfer.getData('text/plain')) {
                try {
                    const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if (dragData.type === 'site') {
                        this.classList.add('drag-over');
                        
                        // 创建并移动占位符
                        let placeholder = document.getElementById('site-placeholder');
                        if (!placeholder) {
                            placeholder = document.createElement('div');
                            placeholder.id = 'site-placeholder';
                            placeholder.className = 'site-card site-placeholder';
                            placeholder.style.height = this.offsetHeight + 'px';
                            placeholder.style.width = this.offsetWidth + 'px';
                            placeholder.style.opacity = '0.7';
                            placeholder.style.backgroundColor = '#0d6efd';
                            placeholder.style.margin = this.style.margin;
                            placeholder.style.borderRadius = '8px';
                        }
                        
                        // 插入占位符到当前元素位置
                        this.parentNode.insertBefore(placeholder, this);
                    }
                } catch (error) {
                    // 忽略数据解析错误
                }
            }
        }
        
        // 处理网站拖拽悬停
        function handleSiteDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        // 处理网站拖拽离开
        function handleSiteDragLeave(e) {
            // 检查是否真的离开了容器
            const relatedTarget = e.relatedTarget;
            if (!this.contains(relatedTarget)) {
                document.querySelectorAll('.site-card.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            }
        }
        
        // 处理网站放置
        function handleSiteDrop(e) {
            e.preventDefault();
            
            try {
                // 获取拖拽数据
                const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                
                if (dragData.type === 'site') {
                    // 获取目标位置信息
                    const targetElement = e.target.closest('.site-card');
                    const dropContainer = this;
                    const containerId = dropContainer.id;
                    const targetTabIndex = parseInt(containerId.replace('sites-container-', ''));
                    
                    if (targetElement) {
                        const targetSiteIndex = parseInt(targetElement.getAttribute('data-site-index'));
                        
                        // 执行拖拽排序
                        if (dragData.tabIndex === targetTabIndex) {
                            // 同一个选项卡内排序
                            reorderSitesWithinTab(dragData.tabIndex, dragData.siteIndex, targetSiteIndex);
                            showToast('网站重新排序成功', 'success');
                        } else {
                            // 跨选项卡移动
                            moveSiteBetweenTabs(dragData.tabIndex, dragData.siteIndex, targetTabIndex, targetSiteIndex);
                            showToast('网站移动成功', 'success');
                        }
                        
                        // 记录用户操作日志
                        logUserAction('reorder_sites', {
                            fromTabIndex: dragData.tabIndex,
                            fromSiteIndex: dragData.siteIndex,
                            toTabIndex: targetTabIndex,
                            toSiteIndex: targetSiteIndex
                        });
                    } else {
                        // 放置在容器空白处，移动到选项卡末尾
                        if (dragData.tabIndex !== targetTabIndex) {
                            moveSiteBetweenTabs(dragData.tabIndex, dragData.siteIndex, targetTabIndex);
                            showToast('网站移动成功', 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('拖拽处理失败:', error);
                showToast('操作失败', 'error');
            } finally {
                // 清理拖拽样式
                handleSiteDragEnd();
            }
        }
        
        // 在同一个选项卡内重新排序网站
        function reorderSitesWithinTab(tabIndex, fromIndex, toIndex) {
            // 确保目标选项卡的数据结构存在
            if (!navData[currentPage].tabs[tabIndex].items) {
                navData[currentPage].tabs[tabIndex].items = [];
            }
            
            const sites = navData[currentPage].tabs[tabIndex].items;
            
            // 从原位置移除
            const [movedSite] = sites.splice(fromIndex, 1);
            
            // 插入到新位置
            sites.splice(toIndex, 0, movedSite);
            
            // 刷新显示
            const container = document.getElementById(`sites-container-${tabIndex}`);
            if (container) {
                container.innerHTML = renderSites(sites, tabIndex);
                bindSiteActions();
                initSiteDragAndDrop(); // 重新绑定拖拽事件
            }
            
            // 标记数据已修改
            setDataChanged();
            
            // 记录日志
            addLogEntry(`重新排序网站: ${movedSite.name}`, LOG_TYPES.SUCCESS);
        }
        
        // 在不同选项卡之间移动网站
        function moveSiteBetweenTabs(fromTabIndex, fromSiteIndex, toTabIndex, toSiteIndex = null) {
            // 确保目标选项卡的数据结构存在
            if (!navData[currentPage].tabs[toTabIndex].items) {
                navData[currentPage].tabs[toTabIndex].items = [];
            }
            
            const fromSites = navData[currentPage].tabs[fromTabIndex].items;
            const toSites = navData[currentPage].tabs[toTabIndex].items;
            
            // 从原位置移除
            const [movedSite] = fromSites.splice(fromSiteIndex, 1);
            
            // 插入到新位置
            if (toSiteIndex !== null && toSiteIndex >= 0 && toSiteIndex <= toSites.length) {
                toSites.splice(toSiteIndex, 0, movedSite);
            } else {
                toSites.push(movedSite);
            }
            
            // 刷新显示
            const fromContainer = document.getElementById(`sites-container-${fromTabIndex}`);
            const toContainer = document.getElementById(`sites-container-${toTabIndex}`);
            
            if (fromContainer) {
                fromContainer.innerHTML = renderSites(fromSites, fromTabIndex);
            }
            
            if (toContainer) {
                toContainer.innerHTML = renderSites(toSites, toTabIndex);
            }
            
            // 重新绑定事件
            bindSiteActions();
            initSiteDragAndDrop();
            
            // 标记数据已修改
            setDataChanged();
            
            // 记录日志
            const fromTabName = navData[currentPage].tabs[fromTabIndex].name;
            const toTabName = navData[currentPage].tabs[toTabIndex].name;
            addLogEntry(`移动网站: ${movedSite.name} 从 "${fromTabName}" 到 "${toTabName}"`, LOG_TYPES.SUCCESS);
        }
        
        // 添加拖拽相关的CSS样式
        function addDragDropStyles() {
            const style = document.createElement('style');
            style.textContent = `
                /* 网站卡片拖拽样式 */
                .site-card {
                    cursor: move;
                    transition: all 0.2s ease;
                    position: relative;
                }
                
                .site-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }
                
                .site-card.dragging {
                    opacity: 0.7;
                    transform: scale(1.05) rotate(2deg);
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                    background-color: rgba(13, 110, 253, 0.1);
                    z-index: 1000;
                    animation: dragPulse 1s ease-in-out infinite;
                }
                
                .site-card.drag-over {
                    border: 2px dashed #0d6efd;
                    background-color: rgba(13, 110, 253, 0.15);
                    transform: scale(1.03);
                    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.3);
                    position: relative;
                }
                
                .site-card.drag-over::after {
                    content: '';
                    position: absolute;
                    inset: -5px;
                    border: 2px solid transparent;
                    border-radius: 8px;
                    background: linear-gradient(90deg, #0d6efd, transparent, #0d6efd) border-box;
                    mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
                    mask-composite: exclude;
                    pointer-events: none;
                    animation: borderShine 2s linear infinite;
                }
                
                /* 选项卡拖拽样式 */
                .nav-item[data-drag-type="tab"] {
                    cursor: move;
                    transition: all 0.2s ease;
                    position: relative;
                    padding: 0.5rem 1rem;
                    border-radius: 0.375rem;
                }
                
                .nav-item[data-drag-type="tab"]:hover {
                    background-color: rgba(13, 110, 253, 0.05);
                }
                
                .nav-item.dragging {
                    opacity: 0.7;
                    transform: scale(1.05) translateY(-3px);
                    background-color: rgba(13, 110, 253, 0.2);
                    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
                    z-index: 1000;
                    animation: dragPulse 1s ease-in-out infinite;
                }
                
                .nav-item.drag-over {
                    border: 2px dashed #0d6efd;
                    background-color: rgba(13, 110, 253, 0.15);
                    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.3);
                }
                
                /* 站点容器拖拽样式 */
                .sites-container {
                    min-height: 100px;
                    transition: all 0.2s ease;
                    border-radius: 0.375rem;
                    padding: 0.5rem;
                }
                
                .sites-container.drag-over {
                    background-color: rgba(13, 110, 253, 0.15);
                    border: 2px dashed #0d6efd;
                    box-shadow: inset 0 0 0 2px rgba(13, 110, 253, 0.2);
                }
                
                /* 动画效果 */
                @keyframes dragPulse {
                    0%, 100% { transform: scale(1.05); }
                    50% { transform: scale(1.08); }
                }
                
                @keyframes borderShine {
                    0% { background-position: 0% 0%; }
                    100% { background-position: 200% 0%; }
                }
                
                /* 拖拽开始动画 */
                .drag-start {
                    animation: dragStart 0.3s ease-out;
                }
                
                @keyframes dragStart {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.08); }
                    100% { transform: scale(1.05); }
                }
                
                /* 拖拽占位符样式 */
                .tab-placeholder {
                    border-radius: 0.375rem;
                    transition: all 0.2s ease;
                    animation: placeholderPulse 1.5s ease-in-out infinite;
                }
                
                .site-placeholder {
                    border-radius: 8px;
                    transition: all 0.2s ease;
                    animation: placeholderPulse 1.5s ease-in-out infinite;
                }
                
                @keyframes placeholderPulse {
                    0%, 100% { opacity: 0.7; }
                    50% { opacity: 0.5; }
                }
                
                /* 跨选项卡拖拽指示器 */
                .sites-container.drag-over::before {
                    content: '放置到此处';
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100%;
                    color: #0d6efd;
                    font-weight: bold;
                    font-size: 1.1rem;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 渲染网站卡片
        function renderSites(sites, tabIndex) {
            if (!sites || sites.length === 0) {
                return '<div class="empty-state"><i class="fas fa-folder-open"></i><p>此选项卡中没有网站</p></div>';
            }
            
            return sites.map((site, siteIndex) => {
                const iconUrl = site.icon || ICON_PREFIX + encodeURIComponent(site.url);
                return '<div class="site-card" data-site-index="'+siteIndex+'" data-tab-index="'+tabIndex+'" draggable="true" data-drag-type="site">' +
                    '<div class="delete-corner" data-tab-index="'+tabIndex+'" data-site-index="'+siteIndex+'">' +
                        '<i class="fas fa-times"></i>' +
                    '</div>' +
                    '<img src="'+iconUrl+'" class="site-icon" alt="'+site.name+'" onerror="this.src=\'../img/index.png\'">' +
                    '<div class="site-name">'+site.name+'</div>' +
                '</div>';
            }).join('');
        }
        
        // 初始化网站拖拽排序功能
        function initSiteDragAndDrop() {
            // 为所有站点容器添加拖放事件
            document.querySelectorAll('.sites-container').forEach(container => {
                container.addEventListener('dragover', handleSiteDragOver);
                container.addEventListener('drop', handleSiteDrop);
                container.addEventListener('dragleave', handleSiteDragLeave);
            });
            
            // 为所有网站卡片添加拖拽事件
            document.querySelectorAll('.site-card').forEach(card => {
                card.addEventListener('dragstart', handleSiteDragStart);
                card.addEventListener('dragend', handleSiteDragEnd);
                card.addEventListener('dragenter', handleSiteDragEnter);
            });
        }
        
        // 处理网站拖拽开始
        function handleSiteDragStart(e) {
            // 添加拖拽样式
            this.classList.add('dragging');
            
            // 设置拖拽数据
            const tabIndex = this.getAttribute('data-tab-index');
            const siteIndex = this.getAttribute('data-site-index');
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: 'site',
                tabIndex: parseInt(tabIndex),
                siteIndex: parseInt(siteIndex)
            }));
        }
        
        // 处理网站拖拽结束
        function handleSiteDragEnd() {
            // 移除所有拖拽相关样式
            document.querySelectorAll('.site-card.dragging, .site-card.drag-over').forEach(el => {
                el.classList.remove('dragging', 'drag-over');
            });
        }
        
        // 处理网站拖拽进入
        function handleSiteDragEnter(e) {
            e.preventDefault();
            // 只在拖拽的是网站时添加样式
            if (e.dataTransfer.getData('text/plain')) {
                const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (dragData.type === 'site') {
                    this.classList.add('drag-over');
                }
            }
        }
        
        // 处理网站拖拽悬停
        function handleSiteDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        // 处理网站拖拽离开
        function handleSiteDragLeave(e) {
            // 检查是否真的离开了容器
            const relatedTarget = e.relatedTarget;
            if (!this.contains(relatedTarget)) {
                document.querySelectorAll('.site-card.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            }
        }
        
        // 处理网站放置
        function handleSiteDrop(e) {
            e.preventDefault();
            
            try {
                // 获取拖拽数据
                const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                
                if (dragData.type === 'site') {
                    // 获取目标位置信息
                    const targetElement = e.target.closest('.site-card');
                    const dropContainer = this;
                    const targetTabIndex = parseInt(dropContainer.id.replace('sites-container-', ''));
                    
                    if (targetElement) {
                        const targetSiteIndex = parseInt(targetElement.getAttribute('data-site-index'));
                        
                        // 执行拖拽排序
                        if (dragData.tabIndex === targetTabIndex) {
                            // 同一个选项卡内排序
                            reorderSitesWithinTab(dragData.tabIndex, dragData.siteIndex, targetSiteIndex);
                        } else {
                            // 跨选项卡移动
                            moveSiteBetweenTabs(dragData.tabIndex, dragData.siteIndex, targetTabIndex, targetSiteIndex);
                        }
                    } else {
                        // 放置在容器空白处，移动到选项卡末尾
                        if (dragData.tabIndex !== targetTabIndex) {
                            moveSiteBetweenTabs(dragData.tabIndex, dragData.siteIndex, targetTabIndex);
                        }
                    }
                }
            } catch (error) {
                console.error('拖拽处理失败:', error);
            }
            
            // 清理拖拽样式
            handleSiteDragEnd();
        }
        
        // 在同一个选项卡内重新排序网站
        function reorderSitesWithinTab(tabIndex, fromIndex, toIndex) {
            // 确保目标选项卡的数据结构存在
            if (!navData[currentPage].tabs[tabIndex].items) {
                navData[currentPage].tabs[tabIndex].items = [];
            }
            
            const sites = navData[currentPage].tabs[tabIndex].items;
            
            // 从原位置移除
            const [movedSite] = sites.splice(fromIndex, 1);
            
            // 插入到新位置
            sites.splice(toIndex, 0, movedSite);
            
            // 刷新显示
            const container = document.getElementById(`sites-container-${tabIndex}`);
            if (container) {
                container.innerHTML = renderSites(sites, tabIndex);
                bindSiteActions();
                initSiteDragAndDrop(); // 重新绑定拖拽事件
            }
            
            // 标记数据已修改
            setDataChanged();
            
            // 记录日志
            addLogEntry(`重新排序网站: ${movedSite.name}`, LOG_TYPES.INFO);
        }
        
        // 在不同选项卡之间移动网站
        function moveSiteBetweenTabs(fromTabIndex, fromSiteIndex, toTabIndex, toSiteIndex = null) {
            // 确保目标选项卡的数据结构存在
            if (!navData[currentPage].tabs[toTabIndex].items) {
                navData[currentPage].tabs[toTabIndex].items = [];
            }
            
            const fromSites = navData[currentPage].tabs[fromTabIndex].items;
            const toSites = navData[currentPage].tabs[toTabIndex].items;
            
            // 从原位置移除
            const [movedSite] = fromSites.splice(fromSiteIndex, 1);
            
            // 插入到新位置
            if (toSiteIndex !== null && toSiteIndex >= 0 && toSiteIndex <= toSites.length) {
                toSites.splice(toSiteIndex, 0, movedSite);
            } else {
                toSites.push(movedSite);
            }
            
            // 刷新显示
            const fromContainer = document.getElementById(`sites-container-${fromTabIndex}`);
            const toContainer = document.getElementById(`sites-container-${toTabIndex}`);
            
            if (fromContainer) {
                fromContainer.innerHTML = renderSites(fromSites, fromTabIndex);
            }
            
            if (toContainer) {
                toContainer.innerHTML = renderSites(toSites, toTabIndex);
            }
            
            // 重新绑定事件
            bindSiteActions();
            initSiteDragAndDrop();
            
            // 标记数据已修改
            setDataChanged();
            
            // 记录日志
            const fromTabName = navData[currentPage].tabs[fromTabIndex].name;
            const toTabName = navData[currentPage].tabs[toTabIndex].name;
            addLogEntry(`移动网站: ${movedSite.name} 从 "${fromTabName}" 到 "${toTabName}"`, LOG_TYPES.INFO);
        }
        
        function bindSiteActions() {
            // 绑定卡片点击事件（编辑）
            document.querySelectorAll('.site-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.delete-corner')) return;
                    
                    const tabIndex = parseInt(this.getAttribute('data-tab-index'));
                    const siteIndex = parseInt(this.getAttribute('data-site-index'));
                    editSite(tabIndex, siteIndex);
                });
            });
            
            // 绑定删除按钮事件
            document.querySelectorAll('.delete-corner').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tabIndex = parseInt(this.getAttribute('data-tab-index'));
                    const siteIndex = parseInt(this.getAttribute('data-site-index'));
                    showDeleteConfirm(tabIndex, siteIndex);
                });
            });
        }
        
        function editSite(tabIndex, siteIndex) {
            const site = navData[currentPage].tabs[tabIndex].items[siteIndex];
            document.getElementById('editSiteTabIndex').value = tabIndex;
            document.getElementById('editSiteIndex').value = siteIndex;
            document.getElementById('editSiteName').value = site.name;
            document.getElementById('editSiteUrl').value = site.url;
            editSiteModal.show();
        }
        
        function saveEditedSite() {
            const tabIndex = parseInt(document.getElementById('editSiteTabIndex').value);
            const siteIndex = parseInt(document.getElementById('editSiteIndex').value);
            const siteName = document.getElementById('editSiteName').value.trim();
            const siteUrl = document.getElementById('editSiteUrl').value.trim();
            
            if (!siteName || !siteUrl) {
                alert('请填写所有字段');
                return;
            }
            
            navData[currentPage].tabs[tabIndex].items[siteIndex] = {
                name: siteName,
                url: siteUrl
                // 不保存icon字段，渲染时自动生成
            };
            
            editSiteModal.hide();
            renderTabs();
            showAlert('网站信息已更新: ' + siteName, 'success');
        }
        
        function showDeleteConfirm(tabIndex, siteIndex) {
            const site = navData[currentPage].tabs[tabIndex].items[siteIndex];
            document.getElementById('deleteTabIndex').value = tabIndex;
            document.getElementById('deleteSiteIndex').value = siteIndex;
            document.getElementById('deleteSiteName').textContent = site.name;
            deleteConfirmModal.show();
        }
        
        function deleteSite() {
            const tabIndex = parseInt(document.getElementById('deleteTabIndex').value);
            const siteIndex = parseInt(document.getElementById('deleteSiteIndex').value);
            const siteName = navData[currentPage].tabs[tabIndex].items[siteIndex].name;
            
            navData[currentPage].tabs[tabIndex].items.splice(siteIndex, 1);
            
            deleteConfirmModal.hide();
            renderTabs();
            
            // 初始化拖拽功能
            setTimeout(() => {
                initSiteDragAndDrop();
                initTabDragAndDrop();
            }, 100);
            
            // 标记数据已修改
            setDataChanged();
            
            showAlert('已删除网站: ' + siteName, 'success');
        }
        
        // 修改添加选项卡按钮交互
        let addTabInput = null;
        let addTabBtnOriginalText = '';
        
        function setupAddTabButton() {
            const addTabBtn = document.getElementById('addTabBtn');
            if (!addTabBtn) return;
            
            addTabBtnOriginalText = addTabBtn.innerHTML;
            
            addTabBtn.addEventListener('click', function() {
                // 如果已经处于编辑模式，执行保存操作
                if (addTabBtn.innerHTML.includes('完成')) {
                    saveNewTab();
                    return;
                }
                
                // 进入编辑模式
                if (!addTabInput) {
                    // 创建输入框
                    addTabInput = document.createElement('input');
                    addTabInput.type = 'text';
                    addTabInput.placeholder = '输入选项卡名称';
                    addTabInput.className = 'form-control form-control-sm mr-2';
                    addTabInput.style.width = 'auto';
                    addTabInput.style.minWidth = '150px';
                    addTabInput.style.maxWidth = '250px';
                    addTabInput.style.display = 'inline-block';
                    addTabInput.style.marginRight = '5px';
                    
                    // 添加到按钮之前
                    addTabBtn.parentNode.insertBefore(addTabInput, addTabBtn);
                    
                    // 处理Enter键保存
                    addTabInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            saveNewTab();
                        } else if (e.key === 'Escape') {
                            cancelAddTab();
                        }
                    });
                    
                    // 处理失焦事件自动保存
                    addTabInput.addEventListener('blur', function() {
                        // 短暂延迟以确保点击按钮的事件可以触发
                        setTimeout(function() {
                            if (addTabInput && !document.activeElement.closest('#addTabBtn')) {
                                saveNewTab();
                            }
                        }, 200);
                    });
                }
                
                // 显示输入框并聚焦
                addTabInput.classList.remove('d-none');
                addTabInput.focus();
                
                // 更改按钮文本为完成
                addTabBtn.innerHTML = '<i class="fas fa-check me-1"></i>完成';
                addTabBtn.classList.remove('btn-outline-light');
                addTabBtn.classList.add('btn-success');
            });
        }
        
        function saveNewTab() {
            if (!addTabInput) return;
            
            const tabName = addTabInput.value.trim();
            if (!tabName) {
                // 如果输入为空，取消添加
                cancelAddTab();
                return;
            }
            
            // 添加新选项卡
            if (!navData[currentPage]) {
                navData[currentPage] = { tabs: [] };
            }
            if (!navData[currentPage].tabs) {
                navData[currentPage].tabs = [];
            }
            
            navData[currentPage].tabs.push({
                name: tabName,
                items: []
            });
            
            // 重置按钮和隐藏输入框
            resetAddTabButton();
            
            // 重新渲染选项卡
            renderTabs();
            
            // 初始化拖拽功能
            setTimeout(() => {
                initSiteDragAndDrop();
                initTabDragAndDrop();
            }, 100);
            
            // 标记数据已修改
            setDataChanged();
            
            // 显示成功提示
            showAlert('已添加选项卡: '+tabName, 'success');
            addLogEntry(`已添加选项卡: ${tabName}`, LOG_TYPES.SUCCESS);
        }
        
        function cancelAddTab() {
            resetAddTabButton();
        }
        
        function resetAddTabButton() {
            if (addTabInput) {
                addTabInput.value = '';
                addTabInput.classList.add('d-none');
            }
            
            const addTabBtn = document.getElementById('addTabBtn');
            if (addTabBtn) {
                addTabBtn.innerHTML = addTabBtnOriginalText;
                addTabBtn.classList.remove('btn-success');
                addTabBtn.classList.add('btn-outline-light');
            }
        }
        
        // 保留原函数以兼容其他调用
        function showAddTabModal() {
            // 现在使用新的交互方式
            const addTabBtn = document.getElementById('addTabBtn');
            if (addTabBtn) {
                addTabBtn.click();
            }
        }
        
        function addNewTab() {
            // 这个函数现在由saveNewTab调用
            saveNewTab();
        }
        
        function addNewSite() {
            const siteName = document.getElementById('siteName').value.trim();
            const siteUrl = document.getElementById('siteUrl').value.trim();
            
            if (!siteName || !siteUrl) {
                alert('请填写所有字段');
                return;
            }
            
            if (!navData[currentPage].tabs[currentTabIndex].items) {
                navData[currentPage].tabs[currentTabIndex].items = [];
            }
            
            navData[currentPage].tabs[currentTabIndex].items.push({
                name: siteName,
                url: siteUrl
                // 不保存icon字段，渲染时自动生成
            });
            
            addSiteModal.hide();
            renderTabs();
            
            // 初始化拖拽功能
            setTimeout(() => {
                initSiteDragAndDrop();
                initTabDragAndDrop();
            }, 100);
            
            // 标记数据已修改
            setDataChanged();
            
            showAlert('已添加网站: '+siteName, 'success');
        }
        
        // 特殊栏目管理功能
        function renderSpecialSites() {
            specialSitesContainer.innerHTML = '';
            
            // 检查特殊栏目是否存在
            if (!navData.more || !navData.more.special || !navData.more.special.sites) {
                // 如果不存在，创建默认结构
                if (!navData.more) navData.more = {};
                if (!navData.more.special) navData.more.special = {};
                navData.more.special.sites = [];
                
                specialSitesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-globe"></i><p>暂无特殊栏目网站，请添加网站</p></div>';
                return;
            }
            
            const sites = navData.more.special.sites;
            
            if (sites.length === 0) {
                specialSitesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-globe"></i><p>暂无特殊栏目网站，请添加网站</p></div>';
                return;
            }
            
            sites.forEach((site, index) => {
                const iconUrl = site.icon || ICON_PREFIX + encodeURIComponent(site.url);
                const siteCard = document.createElement('div');
                siteCard.className = 'site-card';
                siteCard.innerHTML = `
                    <div class="delete-corner" data-site-index="${index}" data-special="true">
                        <i class="fas fa-times"></i>
                    </div>
                    <img src="${iconUrl}" alt="${site.name}" class="site-icon" onerror="this.src='../img/index.png'">
                    <div class="site-name">${site.name}</div>
                `;
                specialSitesContainer.appendChild(siteCard);
                
                // 添加点击编辑事件
                siteCard.addEventListener('click', function(e) {
                    if (!e.target.closest('.delete-corner')) {
                        showEditSpecialSiteModal(index);
                    }
                });
                
                // 添加删除事件
                siteCard.querySelector('.delete-corner').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const siteIndex = this.getAttribute('data-site-index');
                    deleteSpecialSite(siteIndex);
                });
            });
        }
        
        function showAddSpecialSiteModal() {
            document.getElementById('siteName').value = '';
            document.getElementById('siteUrl').value = '';
            document.getElementById('addSiteForm').setAttribute('data-special', 'true');
            addSiteModal.show();
        }
        
        function showEditSpecialSiteModal(siteIndex) {
            const site = navData.more.special.sites[siteIndex];
            document.getElementById('editSiteName').value = site.name;
            document.getElementById('editSiteUrl').value = site.url;
            document.getElementById('editSiteForm').setAttribute('data-special-index', siteIndex);
            editSiteModal.show();
        }
        
        function deleteSpecialSite(siteIndex) {
            if (confirm('确定要删除这个特殊栏目网站吗？')) {
                navData.more.special.sites.splice(siteIndex, 1);
                renderSpecialSites();
                showAlert('特殊栏目网站已删除', 'success');
            }
        }
        
        // 修改添加网站函数以支持特殊栏目
        function addNewSite() {
            const isSpecial = document.getElementById('addSiteForm').hasAttribute('data-special');
            const siteName = document.getElementById('siteName').value.trim();
            const siteUrl = document.getElementById('siteUrl').value.trim();
            
            if (!siteName || !siteUrl) {
                alert('请填写所有字段');
                return;
            }
            
            if (isSpecial) {
                // 添加到特殊栏目
                if (!navData.more.special.sites) {
                    navData.more.special.sites = [];
                }
                
                navData.more.special.sites.push({
                    name: siteName,
                    url: siteUrl
                    // 不保存icon字段，渲染时自动生成
                });
                
                addSiteModal.hide();
                renderSpecialSites();
                showAlert('网站已添加到特殊栏目: '+siteName, 'success');
            } else {
                // 普通添加网站逻辑
                if (!navData[currentPage].tabs[currentTabIndex].items) {
                    navData[currentPage].tabs[currentTabIndex].items = [];
                }
                
                navData[currentPage].tabs[currentTabIndex].items.push({
                    name: siteName,
                    url: siteUrl
                    // 不保存icon字段，渲染时自动生成
                });
                
                addSiteModal.hide();
                renderTabs();
                showAlert('已添加网站: '+siteName, 'success');
            }
        }
        
        // 修改保存编辑网站函数以支持特殊栏目
        function saveEditedSite() {
            const isSpecial = document.getElementById('editSiteForm').hasAttribute('data-special-index');
            const siteName = document.getElementById('editSiteName').value.trim();
            const siteUrl = document.getElementById('editSiteUrl').value.trim();
            
            if (!siteName || !siteUrl) {
                alert('请填写所有字段');
                return;
            }
            
            if (isSpecial) {
                // 编辑特殊栏目网站
                const siteIndex = parseInt(document.getElementById('editSiteForm').getAttribute('data-special-index'));
                navData.more.special.sites[siteIndex] = {
                    name: siteName,
                    url: siteUrl
                    // 不保存icon字段，渲染时自动生成
                };
                
                editSiteModal.hide();
                renderSpecialSites();
                showAlert('特殊栏目网站已更新: '+siteName, 'success');
            } else {
                // 普通编辑网站逻辑
                const tabIndex = parseInt(document.getElementById('editSiteTabIndex').value);
                const siteIndex = parseInt(document.getElementById('editSiteIndex').value);
                navData[currentPage].tabs[tabIndex].items[siteIndex] = {
                    name: siteName,
                    url: siteUrl
                    // 不保存icon字段，渲染时自动生成
                };
                
                editSiteModal.hide();
                renderTabs();
                showAlert('网站已更新: '+siteName, 'success');
            }
        }
        
        function saveNavData() {
            try {
                // 创建下载链接
                const dataStr = JSON.stringify(navData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'nav-data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('导航数据已保存并准备好下载', 'success');
            } catch (e) {
                console.error('保存数据时出错:', e);
                showAlert('保存数据时出错', 'danger');
            }
        }
        
        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert-floating');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-'+type+' alert-floating position-fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '1050';
            alert.style.minWidth = '300px';
            alert.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            alert.innerHTML = '<div class="d-flex align-items-center"><i class="fas '+(type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle')+' me-2"></i><div>'+message+'</div><button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button></div>';
            document.body.appendChild(alert);
            
            // 记录到操作日志
            addLogEntry(message, type);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // 日志管理功能
        function addLogEntry(message, type = LOG_TYPES.INFO, details = '') {
            const logEntry = {
                timestamp: new Date().toLocaleString('zh-CN'),
                message: message,
                type: type,
                details: details
            };
            
            operationLogs.unshift(logEntry); // 添加到开头，最新的在最上面
            
            // 限制日志数量，最多保留100条
            if (operationLogs.length > 100) {
                operationLogs = operationLogs.slice(0, 100);
            }
            
            renderLogs();
        }
        
        function renderLogs() {
            logContainer.innerHTML = '';
            
            if (operationLogs.length === 0) {
                // 创建空状态提示
                const emptyState = document.createElement('div');
                emptyState.className = 'text-center text-muted p-3';
                emptyState.innerHTML = '<i class="fas fa-history mr-2"></i>暂无操作日志';
                logContainer.appendChild(emptyState);
                return;
            }
            
            operationLogs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${log.type}`;
                
                const iconClass = {
                    'success': 'fa-check-circle text-success',
                    'error': 'fa-exclamation-circle text-danger',
                    'warning': 'fa-exclamation-triangle text-warning',
                    'info': 'fa-info-circle text-info'
                }[log.type] || 'fa-info-circle text-info';
                
                logEntry.innerHTML = `
                    <div class="log-time">
                        <i class="fas fa-clock me-1"></i>${log.timestamp}
                    </div>
                    <div class="log-message">
                        <i class="fas ${iconClass} me-2"></i>${log.message}
                    </div>
                    ${log.details ? `<div class="log-details">${log.details}</div>` : ''}
                `;
                
                logContainer.appendChild(logEntry);
            });
        }
        
        function clearAllLogs() {
            if (confirm('确定要清空所有操作日志吗？此操作不可撤销！')) {
                operationLogs = [];
                renderLogs();
                addLogEntry('操作日志已清空', LOG_TYPES.INFO);
            }
        }
        
        // 修改现有的关键函数以记录日志
        function loadFromJsonFile() {
            const filePath = '../../js/nav-data.json';
            const fullPath = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/') + filePath;
            
            // 记录开始加载
            addLogEntry('开始加载导航数据', LOG_TYPES.INFO, `文件路径: ${filePath}, 完整路径: ${fullPath}, 来源: 本地文件`);
            
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应不正常');
                    }
                    return response.json();
                })
                .then(data => {
                    // 确保版本信息存在
                    if (!data.version) {
                        data.version = {
                            web_vol: "1.0.0",
                            web_data: new Date().toISOString().split('T')[0].replace(/-/g, '.')
                        };
                    }
                    
                    navData = data;
                    renderTabs();
                    renderSpecialSites();
                    updateVersionDisplay();
                    updateSpecialSectionVisibility();
                    
                    // 初始化拖拽功能
                    setTimeout(() => {
                        initSiteDragAndDrop();
                        initTabDragAndDrop();
                    }, 100);
                    showAlert('数据已从本地JSON文件加载', 'success');
                    
                    // 记录成功加载
                    addLogEntry('JSON文件加载成功', LOG_TYPES.SUCCESS, `从本地文件加载导航数据成功，文件路径: ${filePath}, 来源: 本地文件`);
                    
                    // 显示本地加载标识
                    showDataSourceIndicator('local');
                })
                .catch(error => {
                    console.error('加载本地JSON文件失败:', error);
                    showAlert('加载本地JSON文件失败: ' + error.message, 'danger');
                    
                    // 记录加载失败
                    addLogEntry('JSON文件加载失败', LOG_TYPES.ERROR, `文件路径: ${filePath}, 错误信息: ${error.message}, 来源: 本地文件`);
                    
                    // 如果没有本地数据，使用默认结构
                    navData = {
                        version: {
                            web_vol: "1.0.0",
                            web_data: new Date().toISOString().split('T')[0].replace(/-/g, '.')
                        },
                        index: { tabs: [] },
                        more: { tabs: [] },
                        dd: { tabs: [] },
                        download: { tabs: [] },
                        develop: { tabs: [] }
                    };
                    
                    document.getElementById('navTabContent').innerHTML = '<div class="empty-state"><i class="fas fa-cloud-upload-alt"></i><p>暂无数据，请先上传JSON文件或添加内容</p></div>';
                });
        }
        
        // 更新数据修改标识
        function updateDataChangeIndicator() {
            // 获取保存按钮所在的卡片容器
            const saveCard = document.getElementById('saveBtn').closest('.feature-card');
            if (!saveCard) return;
            
            // 移除旧的标识
            const existingBadge = saveCard.querySelector('.data-change-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // 如果数据已修改，添加新标识
            if (dataHasChanged) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-danger position-absolute top-2 right-2 data-change-badge';
                badge.textContent = 'NEW';
                badge.style.zIndex = '10';
                saveCard.style.position = 'relative';
                saveCard.appendChild(badge);
            }
        }
        
        // 显示数据加载来源标识
        function showDataSourceIndicator(source) {
            // 移除所有卡片上的加载来源标识
            document.querySelectorAll('.data-source-badge').forEach(badge => badge.remove());
            
            let targetCard;
            let badgeText;
            let badgeBg;
            
            if (source === 'local') {
                // 本地文件加载
                targetCard = document.getElementById('loadFromLocalBtn').closest('.feature-card');
                badgeText = '已加载';
                badgeBg = 'bg-success';
            } else if (source === 'upload') {
                // 手动上传
                // 找到上传JSON卡片（通过卡片中的图标来定位）
                targetCard = document.querySelector('.feature-icon i.fa-file-upload').closest('.feature-card');
                badgeText = '已上传';
                badgeBg = 'bg-info';
            }
            
            if (targetCard) {
                targetCard.style.position = 'relative';
                const badge = document.createElement('span');
                badge.className = `badge ${badgeBg} position-absolute top-2 right-2 data-source-badge`;
                badge.textContent = badgeText;
                badge.style.zIndex = '10';
                targetCard.appendChild(badge);
            }
        }
        
        // 设置数据已修改
        function setDataChanged() {
            dataHasChanged = true;
            updateDataChangeIndicator();
        }
        
        // 重置数据修改状态
        function resetDataChanged() {
            dataHasChanged = false;
            updateDataChangeIndicator();
        }
        
        function saveNavData() {
            try {
                // 保存前先验证数据
                const validationErrors = validateNavData(navData);
                
                if (validationErrors.length > 0) {
                    // 尝试自动修复
                    const repairResult = repairNavData(navData);
                    
                    // 显示修复结果
                    showAlert(`发现${validationErrors.length}个数据结构问题，已自动修复${repairResult.repairs.length}处，现在保存数据`, 'info');
                    
                    // 记录修复信息
                    addLogEntry('保存前数据验证失败，已自动修复', LOG_TYPES.INFO, 
                        `问题: ${validationErrors.length}个\n修复: ${repairResult.repairs.length}处\n修复详情: ${repairResult.repairs.join('\n')}`);
                    
                    // 使用修复后的数据
                    navData = repairResult.data;
                }
                
                // 序列化数据为JSON
                let dataStr;
                try {
                    dataStr = JSON.stringify(navData, null, 2);
                } catch (stringifyError) {
                    throw new Error(`数据序列化失败: ${stringifyError.message}`);
                }
                
                // 创建下载链接
                try {
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    
                    // 生成带时间戳的文件名
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    link.download = `nav-data-${timestamp}.json`;
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                    }, 100);
                    
                    // 重置数据修改状态
                    resetDataChanged();
                    
                    showAlert('导航数据已保存并准备好下载', 'success');
                    
                    // 记录保存操作
                    addLogEntry('数据保存成功', LOG_TYPES.SUCCESS, '导航数据已导出为JSON文件');
                } catch (downloadError) {
                    // 如果下载失败，提供备选方案 - 将JSON复制到剪贴板
                    try {
                        navigator.clipboard.writeText(dataStr)
                            .then(() => {
                                showAlert('由于浏览器限制无法直接下载文件，但已将数据复制到剪贴板，请手动保存', 'warning');
                                addLogEntry('数据保存为剪贴板内容', LOG_TYPES.WARNING, '下载失败，已复制到剪贴板');
                            })
                            .catch(() => {
                                // 如果剪贴板也失败，显示原始数据在模态框
                                showJsonPreviewModal(dataStr);
                            });
                    } catch (clipboardError) {
                        throw new Error(`保存失败: ${downloadError.message}\n备选方法也失败: ${clipboardError.message}`);
                    }
                }
            } catch (e) {
                console.error('保存数据时出错:', e);
                showAlert('保存数据时出错: ' + e.message, 'danger');
                
                // 记录详细错误信息
                addLogEntry('数据保存失败', LOG_TYPES.ERROR, JSON.stringify({
                    message: e.message,
                    stack: e.stack,
                    dataSize: navData ? JSON.stringify(navData).length : 'unknown',
                    timestamp: new Date().toISOString()
                }, null, 2));
            }
        }
        
        // 完整的导航数据验证函数
        function validateNavData(data) {
            const errors = [];
            
            // 检查数据是否为对象
            if (!data || typeof data !== 'object') {
                errors.push('数据必须是一个有效的JSON对象');
                return errors;
            }
            
            // 检查必要的顶层字段
            if (!data.version) {
                errors.push('缺少必要的version字段');
            } else if (typeof data.version !== 'object') {
                errors.push('version字段必须是一个对象');
            } else {
                // 检查版本字段结构
                if (!data.version.web_vol) {
                    errors.push('缺少必要的version.web_vol字段');
                } else if (typeof data.version.web_vol !== 'string') {
                    errors.push('version.web_vol必须是一个字符串');
                }
            }
            
            // 检查至少有一个页面数据
            const hasPages = Object.keys(data).some(key => key !== 'version' && 
                                                     typeof data[key] === 'object' && 
                                                     data[key].tabs);
            
            if (!hasPages) {
                errors.push('数据中必须包含至少一个有效的页面配置');
            }
            
            // 对每个页面进行验证
            Object.keys(data).forEach(pageKey => {
                if (pageKey === 'version') return;
                
                const page = data[pageKey];
                if (!page || typeof page !== 'object') return;
                
                // 验证选项卡配置
                if (page.tabs) {
                    if (!Array.isArray(page.tabs)) {
                        errors.push(`页面 ${pageKey} 的tabs必须是一个数组`);
                    } else {
                        // 验证每个选项卡
                        page.tabs.forEach((tab, tabIndex) => {
                            if (!tab) {
                                errors.push(`页面 ${pageKey} 的选项卡 ${tabIndex + 1} 不能为空`);
                                return;
                            }
                            
                            if (!tab.name) {
                                errors.push(`页面 ${pageKey} 的选项卡 ${tabIndex + 1} 缺少name字段`);
                            } else if (typeof tab.name !== 'string' || tab.name.trim() === '') {
                                errors.push(`页面 ${pageKey} 的选项卡 ${tabIndex + 1} 的name必须是非空字符串`);
                            }
                            
                            // 验证选项卡中的网站
                            if (tab.items) {
                                if (!Array.isArray(tab.items)) {
                                    errors.push(`页面 ${pageKey} 的选项卡 "${tab.name || tabIndex + 1}" 的items必须是一个数组`);
                                } else {
                                    tab.items.forEach((site, siteIndex) => {
                                        if (!site) {
                                            errors.push(`页面 ${pageKey} 的选项卡 "${tab.name || tabIndex + 1}" 中的网站 ${siteIndex + 1} 不能为空`);
                                            return;
                                        }
                                        
                                        const siteErrors = validateSiteData(site, pageKey, tab.name || tabIndex + 1, siteIndex + 1);
                                        if (siteErrors.length > 0) {
                                            errors.push(...siteErrors);
                                        }
                                    });
                                }
                            }
                        });
                    }
                }
                
                // 验证特殊栏目（如果存在）
                if (pageKey === 'more' && page.special && page.special.sites) {
                    if (!Array.isArray(page.special.sites)) {
                        errors.push('特殊栏目的sites必须是一个数组');
                    } else {
                        page.special.sites.forEach((site, siteIndex) => {
                            if (!site) {
                                errors.push(`特殊栏目中的网站 ${siteIndex + 1} 不能为空`);
                                return;
                            }
                            
                            const siteErrors = validateSiteData(site, '特殊栏目', '', siteIndex + 1);
                            if (siteErrors.length > 0) {
                                errors.push(...siteErrors);
                            }
                        });
                    }
                }
            });
            
            return errors;
        }
        
        // 验证单个网站数据
        function validateSiteData(site, page, tab, index) {
            const errors = [];
            const siteIdentifier = site.name || index;
            const locationInfo = `页面 ${page} ${tab ? '选项卡 "' + tab + '" ' : ''}中的网站 "${siteIdentifier}"`;
            
            // 确保site是对象
            if (!site || typeof site !== 'object') {
                errors.push(`${locationInfo} 数据不是有效的对象`);
                return errors;
            }
            
            // 验证name字段
            if (!site.name) {
                errors.push(`${locationInfo} 缺少name字段`);
            } else if (typeof site.name !== 'string') {
                errors.push(`${locationInfo} 的name字段必须是字符串类型`);
            } else if (site.name.trim() === '') {
                errors.push(`${locationInfo} 的name字段不能为空字符串`);
            } else if (site.name.length > 100) {
                errors.push(`${locationInfo} 的name字段长度不能超过100个字符（当前${site.name.length}个）`);
            }
            
            // 验证url字段
            if (!site.url) {
                errors.push(`${locationInfo} 缺少url字段`);
            } else if (typeof site.url !== 'string') {
                errors.push(`${locationInfo} 的url字段必须是字符串类型`);
            } else if (site.url.trim() === '') {
                errors.push(`${locationInfo} 的url字段不能为空字符串`);
            } else {
                // 对URL进行格式验证
                const urlErrors = checkSingleUrl(site.url);
                if (urlErrors.length > 0) {
                    errors.push(`${locationInfo} 的URL有错误: ${urlErrors.join(', ')}`);
                }
            }
            
            // 验证icon字段（如果存在）
            if (site.icon !== undefined) {
                if (typeof site.icon !== 'string') {
                    errors.push(`${locationInfo} 的icon字段必须是字符串类型`);
                } else if (site.icon.trim() !== '') {
                    const iconErrors = checkSingleUrl(site.icon);
                    if (iconErrors.length > 0) {
                        errors.push(`${locationInfo} 的图标URL有错误: ${iconErrors.join(', ')}`);
                    }
                }
            }
            
            // 验证color字段（如果存在）
            if (site.color !== undefined) {
                if (typeof site.color !== 'string') {
                    errors.push(`${locationInfo} 的color字段必须是字符串类型`);
                } else if (site.color.trim() !== '') {
                    const colorRegex = /^#[0-9A-Fa-f]{6}$/;
                    if (!colorRegex.test(site.color)) {
                        errors.push(`${locationInfo} 的颜色格式无效，请使用十六进制格式（如 #123456）`);
                    }
                }
            }
            
            // 验证id字段（如果存在）
            if (site.id !== undefined) {
                if (typeof site.id !== 'string') {
                    errors.push(`${locationInfo} 的id字段必须是字符串类型`);
                } else if (!/^[a-zA-Z0-9_-]+$/.test(site.id)) {
                    errors.push(`${locationInfo} 的id只能包含字母、数字、下划线和连字符`);
                } else if (site.id.length > 50) {
                    errors.push(`${locationInfo} 的id长度不能超过50个字符`);
                }
            }
            
            // 验证description字段（如果存在）
            if (site.description !== undefined && typeof site.description !== 'string') {
                errors.push(`${locationInfo} 的description字段必须是字符串类型`);
            } else if (site.description && site.description.length > 500) {
                errors.push(`${locationInfo} 的description长度不能超过500个字符`);
            }
            
            // 验证category字段（如果存在）
            if (site.category !== undefined && typeof site.category !== 'string') {
                errors.push(`${locationInfo} 的category字段必须是字符串类型`);
            } else if (site.category && site.category.length > 50) {
                errors.push(`${locationInfo} 的category长度不能超过50个字符`);
            }
            
            // 验证tags字段（如果存在）
            if (site.tags !== undefined && !Array.isArray(site.tags)) {
                errors.push(`${locationInfo} 的tags字段必须是数组类型`);
            } else if (site.tags) {
                // 检查标签内容
                for (let i = 0; i < site.tags.length; i++) {
                    if (typeof site.tags[i] !== 'string') {
                        errors.push(`${locationInfo} 的标签 ${i + 1} 必须是字符串类型`);
                    } else if (site.tags[i].length > 30) {
                        errors.push(`${locationInfo} 的标签 "${site.tags[i]}" 长度不能超过30个字符`);
                    }
                }
            }
            
            return errors;
        }
        
        // 数据修复函数
        function repairNavData(data) {
            const repairedData = JSON.parse(JSON.stringify(data)); // 深拷贝
            const repairs = [];
            
            // 确保data是对象
            if (!repairedData || typeof repairedData !== 'object') {
                return { data: { version: { web_vol: '1.0.0', web_data: new Date().toISOString().split('T')[0].replace(/-/g, '.') } }, 
                         repairs: ['创建了全新的数据结构，原始数据无效'] };
            }
            
            // 确保version对象存在
            if (!repairedData.version || typeof repairedData.version !== 'object') {
                repairedData.version = {};
                repairs.push('创建了缺失的version对象');
            }
            
            // 确保版本字段存在且为字符串类型
            if (!repairedData.version.web_vol || typeof repairedData.version.web_vol !== 'string') {
                repairedData.version.web_vol = '1.0.0';
                repairs.push('添加/修复了缺失的version.web_vol字段，设置为默认值 "1.0.0"');
            }
            
            if (!repairedData.version.web_data || typeof repairedData.version.web_data !== 'string') {
                repairedData.version.web_data = new Date().toISOString().split('T')[0].replace(/-/g, '.');
                repairs.push('添加/修复了缺失的version.web_data字段，设置为当前日期');
            }
            
            // 修复每个页面的数据
            Object.keys(repairedData).forEach(pageKey => {
                // 跳过版本对象
                if (pageKey === 'version') return;
                
                let pageData = repairedData[pageKey];
                
                // 确保页面数据是对象
                if (!pageData || typeof pageData !== 'object') {
                    pageData = { tabs: [] };
                    repairedData[pageKey] = pageData;
                    repairs.push(`页面 ${pageKey} 数据无效，创建了新的页面结构`);
                }
                
                // 确保tabs数组存在
                if (!pageData.tabs || !Array.isArray(pageData.tabs)) {
                    pageData.tabs = [];
                    repairs.push(`页面 ${pageKey} 缺少tabs数组，已创建`);
                }
                
                // 修复每个选项卡
                pageData.tabs.forEach((tab, tabIndex) => {
                    // 确保选项卡有名称
                    if (!tab.name || tab.name.trim() === '') {
                        tab.name = `未命名选项卡 ${tabIndex + 1}`;
                        repairs.push(`页面 ${pageKey} 选项卡 ${tabIndex + 1} 缺少名称，已设置为默认名称`);
                    }
                    
                    // 确保items数组存在
                    if (!tab.items || !Array.isArray(tab.items)) {
                        tab.items = [];
                        repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 缺少items数组，已创建`);
                    }
                    
                    // 修复每个网站
                    tab.items.forEach((site, siteIndex) => {
                        if (!site || typeof site !== 'object') {
                            // 如果网站数据无效，替换为基本结构
                            tab.items[siteIndex] = {
                                name: `未命名网站 ${siteIndex + 1}`,
                                url: '#'
                            };
                            repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 ${siteIndex + 1} 数据无效，已重置`);
                            return;
                        }
                        
                        // 修复name字段
                        if (!site.name || typeof site.name !== 'string' || site.name.trim() === '') {
                            site.name = `未命名网站 ${siteIndex + 1}`;
                            repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 ${siteIndex + 1} 缺少有效名称，已设置为默认名称`);
                        } else if (site.name.length > 100) {
                            site.name = site.name.substring(0, 97) + '...';
                            repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name.substring(0, 20)}..." 名称过长，已截断`);
                        }
                        
                        // 修复url字段
                        if (!site.url || typeof site.url !== 'string' || site.url.trim() === '') {
                            site.url = '#';
                            repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" 缺少URL，已设置为占位符`);
                        } else {
                            // 尝试修复URL格式
                            const urlErrors = checkSingleUrl(site.url);
                            if (urlErrors.length > 0) {
                                // 尝试修复URL
                                const fixedUrl = fixUrl(site.url);
                                if (fixedUrl !== site.url) {
                                    site.url = fixedUrl;
                                    repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" URL已自动修复`);
                                }
                            }
                        }
                        
                        // 修复icon字段（如果存在）
                        if (site.icon !== undefined) {
                            if (typeof site.icon !== 'string') {
                                delete site.icon;
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" icon字段类型错误，已移除`);
                            } else if (site.icon.trim() !== '') {
                                const iconErrors = checkSingleUrl(site.icon);
                                if (iconErrors.length > 0) {
                                    delete site.icon;
                                    repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" 图标URL格式错误，已移除`);
                                }
                            }
                        }
                        
                        // 修复color字段（如果存在）
                        if (site.color !== undefined) {
                            if (typeof site.color !== 'string') {
                                delete site.color;
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" color字段类型错误，已移除`);
                            } else if (site.color.trim() !== '') {
                                const colorRegex = /^#[0-9A-Fa-f]{6}$/;
                                if (!colorRegex.test(site.color)) {
                                    delete site.color;
                                    repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" 颜色格式错误，已移除`);
                                }
                            }
                        }
                        
                        // 修复id字段（如果存在）
                        if (site.id !== undefined) {
                            if (typeof site.id !== 'string') {
                                delete site.id;
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" id字段类型错误，已移除`);
                            } else {
                                // 清理无效字符
                                const cleanedId = site.id.replace(/[^a-zA-Z0-9_-]/g, '');
                                if (cleanedId !== site.id) {
                                    site.id = cleanedId;
                                    repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" id包含无效字符，已清理`);
                                }
                                // 截断过长的id
                                if (site.id.length > 50) {
                                    site.id = site.id.substring(0, 50);
                                    repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" id过长，已截断`);
                                }
                                // 如果id为空，移除
                                if (site.id === '') {
                                    delete site.id;
                                }
                            }
                        }
                        
                        // 修复description字段（如果存在）
                        if (site.description !== undefined) {
                            if (typeof site.description !== 'string') {
                                delete site.description;
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" description字段类型错误，已移除`);
                            } else if (site.description.length > 500) {
                                site.description = site.description.substring(0, 497) + '...';
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" 描述过长，已截断`);
                            }
                        }
                        
                        // 修复category字段（如果存在）
                        if (site.category !== undefined) {
                            if (typeof site.category !== 'string') {
                                delete site.category;
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" category字段类型错误，已移除`);
                            } else if (site.category.length > 50) {
                                site.category = site.category.substring(0, 47) + '...';
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" 类别过长，已截断`);
                            }
                        }
                        
                        // 修复tags字段（如果存在）
                        if (site.tags !== undefined) {
                            if (!Array.isArray(site.tags)) {
                                delete site.tags;
                                repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" tags字段类型错误，已移除`);
                            } else {
                                // 过滤和修复标签
                                const originalLength = site.tags.length;
                                site.tags = site.tags.filter(tag => {
                                    if (typeof tag === 'string' && tag.trim() !== '') {
                                        return true;
                                    }
                                    repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" 移除了无效标签`);
                                    return false;
                                });
                                
                                // 修复过长的标签
                                site.tags = site.tags.map(tag => {
                                    if (tag.length > 30) {
                                        repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 中的网站 "${site.name}" 标签过长，已截断`);
                                        return tag.substring(0, 27) + '...';
                                    }
                                    return tag;
                                });
                            }
                        }
                    });
                    
                    // 移除重复的网站
                    const siteNames = new Set();
                    const uniqueSites = [];
                    tab.items.forEach(site => {
                        if (!siteNames.has(site.name)) {
                            siteNames.add(site.name);
                            uniqueSites.push(site);
                        }
                    });
                    
                    if (uniqueSites.length < tab.items.length) {
                        tab.items = uniqueSites;
                        repairs.push(`页面 ${pageKey} 选项卡 "${tab.name}" 移除了重复的网站`);
                    }
                });
                
                // 移除空选项卡
                const nonEmptyTabs = pageData.tabs.filter(tab => 
                    tab && tab.items && tab.items.length > 0
                );
                
                if (nonEmptyTabs.length < pageData.tabs.length) {
                    pageData.tabs = nonEmptyTabs;
                    repairs.push(`页面 ${pageKey} 移除了空选项卡`);
                }
                
                // 如果页面没有选项卡，创建一个默认选项卡
                if (pageData.tabs.length === 0) {
                    pageData.tabs.push({
                        name: '默认选项卡',
                        items: []
                    });
                    repairs.push(`页面 ${pageKey} 缺少选项卡，已创建默认选项卡`);
                }
            });
            
            return { data: repairedData, repairs };
        }
        // 原始函数实现已被完全替换为上面的新版本
        
        function processUploadedFile() {
            const file = jsonFileInput.files[0];
            if (!file) {
                showAlert('请先选择文件', 'warning');
                return;
            }
            
            // 文件类型验证
            const validExtensions = ['json'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExtension)) {
                showAlert('请选择JSON格式的文件', 'danger');
                addLogEntry('文件类型错误', LOG_TYPES.ERROR, `文件名: ${file.name}, 类型: ${fileExtension}, 支持的类型: ${validExtensions.join(', ')}`);
                return;
            }
            
            // 文件大小验证
            const maxFileSize = 1 * 1024 * 1024; // 1MB
            if (file.size > maxFileSize) {
                showAlert('文件大小不能超过1MB', 'danger');
                addLogEntry('文件大小超限', LOG_TYPES.ERROR, `文件名: ${file.name}, 大小: ${(file.size / 1024).toFixed(2)} KB, 最大允许: ${(maxFileSize / 1024).toFixed(0)} KB`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // JSON解析错误处理
                    let uploadedData;
                    try {
                        uploadedData = JSON.parse(e.target.result);
                    } catch (parseError) {
                        let errorDetail = parseError.message;
                        // 提供更详细的解析错误信息
                        if (errorDetail.includes('Unexpected token')) {
                            const lineNumber = e.target.result.substring(0, parseError.position).split('\n').length;
                            errorDetail += ` (第${lineNumber}行)`;
                        }
                        throw new Error(`JSON解析失败: ${errorDetail}`);
                    }
                    
                    // 数据验证
                    const validationErrors = validateNavData(uploadedData);
                    
                    // 处理验证错误
                    if (validationErrors.length > 0) {
                        // 尝试自动修复
                        const repairResult = repairNavData(uploadedData);
                        
                        // 显示修复结果并确认是否使用修复后的数据
                        const errorMessage = `发现${validationErrors.length}个数据结构错误，已尝试自动修复${repairResult.repairs.length}处`;
                        showAlert(errorMessage, 'warning');
                        
                        // 记录修复信息
                        addLogEntry('数据验证失败但已尝试修复', LOG_TYPES.WARNING, 
                            `错误: ${validationErrors.length}个\n修复: ${repairResult.repairs.length}处\n修复详情: ${repairResult.repairs.join('\n')}`);
                        
                        // 使用修复后的数据
                        uploadedData = repairResult.data;
                    }
                    
                    // 使用验证/修复后的数据
                    navData = uploadedData;
                    
                    // 更新界面
                    try {
                        renderTabs();
                        renderSpecialSites();
                        updateVersionDisplay();
                        updateSpecialSectionVisibility();
                        
                        // 初始化拖拽功能
                        setTimeout(() => {
                            initSiteDragAndDrop();
                            initTabDragAndDrop();
                        }, 100);
                        
                        uploadModal.hide();
                        showAlert('JSON文件上传成功', 'success');
                        
                        // 记录上传成功
                        addLogEntry('JSON文件上传成功', LOG_TYPES.SUCCESS, 
                            `文件名: ${file.name}, 大小: ${(file.size / 1024).toFixed(2)} KB`);
                    } catch (renderError) {
                        throw new Error(`数据上传成功，但渲染界面时出错: ${renderError.message}`);
                    }
                } catch (error) {
                    console.error('处理上传文件失败:', error);
                    showAlert('处理上传文件失败: ' + error.message, 'danger');
                    
                    // 记录详细错误信息
                    const errorDetails = {
                        message: error.message,
                        stack: error.stack,
                        fileName: file.name,
                        fileSize: (file.size / 1024).toFixed(2) + ' KB',
                        timestamp: new Date().toISOString()
                    };
                    addLogEntry('文件处理失败', LOG_TYPES.ERROR, JSON.stringify(errorDetails, null, 2));
                }
            };
            
            reader.onerror = function(error) {
                const errorMessage = '读取文件失败: ' + (error.target.error ? error.target.error.message : '未知错误');
                showAlert(errorMessage, 'danger');
                addLogEntry('文件读取失败', LOG_TYPES.ERROR, 
                    `文件名: ${file.name}, 错误: ${error.target.error ? error.target.error.name : 'unknown'}`);
            };
            
            reader.readAsText(file);
        }
        
        // URL错误检查函数
        function checkUrlErrors() {
            if (!navData || Object.keys(navData).length === 0) {
                showAlert('请先加载导航数据', 'warning');
                return;
            }
            
            urlErrorsToFix = [];
            let errorCount = 0;
            
            // 检查所有页面的选项卡中的网站URL
            Object.keys(navData).forEach(page => {
                if (navData[page] && navData[page].tabs) {
                    navData[page].tabs.forEach((tab, tabIndex) => {
                        if (tab.items) {
                            tab.items.forEach((site, siteIndex) => {
                                if (site.url) {
                                    const errors = checkSingleUrl(site.url);
                                    if (errors.length > 0) {
                                        urlErrorsToFix.push({
                                            page,
                                            tabIndex,
                                            siteIndex,
                                            originalUrl: site.url,
                                            fixedUrl: fixUrl(site.url),
                                            errors,
                                            isSpecial: false
                                        });
                                        errorCount++;
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            // 检查特殊栏目中的网站URL
            if (navData.more && navData.more.special && navData.more.special.sites) {
                navData.more.special.sites.forEach((site, siteIndex) => {
                    if (site.url) {
                        const errors = checkSingleUrl(site.url);
                        if (errors.length > 0) {
                            urlErrorsToFix.push({
                                page: 'more',
                                siteIndex,
                                originalUrl: site.url,
                                fixedUrl: fixUrl(site.url),
                                errors,
                                isSpecial: true
                            });
                            errorCount++;
                        }
                    }
                });
            }
            
            // 显示在工具功能下方
            displayUrlErrorsInMainArea();
            
            if (errorCount === 0) {
                showAlert('未发现URL错误', 'success');
                addLogEntry('URL检查完成', LOG_TYPES.SUCCESS, '所有URL格式正确');
            } else {
                // 仅记录日志，不显示模态框
                addLogEntry(`发现${errorCount}个URL错误`, LOG_TYPES.WARNING, '请在工具功能下方查看详情');
            }
        }
        
        // 检查单个URL的错误
        function checkSingleUrl(url) {
            const errors = [];
            
            // 检查是否为空
            if (!url || url.trim() === '') {
                errors.push('URL为空');
                return errors;
            }
            
            // 检查是否缺少协议
            if (!url.match(/^https?:\/\//i)) {
                errors.push('缺少http/https协议');
            }
            
            // 检查是否有多余的空格
            if (url.trim() !== url) {
                errors.push('包含多余的空格');
            }
            
            // 检查是否有多余的斜杠
            if (url.match(/\/{3,}/)) {
                errors.push('包含连续多个斜杠');
            }
            
            // 检查是否有无效字符
            if (!url.match(/^[a-zA-Z0-9:\/?#\[\]@!$&'()*+,;=._~-]+$/)) {
                errors.push('包含无效字符');
            }
            
            return errors;
        }
        
        // 修复URL错误
        function fixUrl(url) {
            let fixed = url;
            
            // 去除多余的空格
            fixed = fixed.trim();
            
            // 添加协议
            if (!fixed.match(/^https?:\/\//i)) {
                fixed = 'https://' + fixed;
            }
            
            // 替换多个斜杠为单个斜杠
            fixed = fixed.replace(/\/(?=\/)/g, '');
            
            return fixed;
        }
        
        // 显示URL错误
        // 在工具功能下方显示URL错误结果
        function displayUrlErrorsInMainArea() {
            const urlErrorsDisplay = document.getElementById('urlErrorsDisplay');
            const urlErrorsContent = document.getElementById('urlErrorsContent');
            
            if (!urlErrorsDisplay || !urlErrorsContent) return;
            
            urlErrorsDisplay.classList.remove('d-none');
            
            if (urlErrorsToFix.length === 0) {
                urlErrorsContent.innerHTML = '<div class="text-center text-success py-2">未发现URL错误</div>';
                return;
            }
            
            // 添加错误统计和操作按钮
            urlErrorsContent.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="text-danger font-medium">发现 ${urlErrorsToFix.length} 个URL错误</div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" id="selectAllUrlErrors">
                            <i class="fas fa-check-double me-1"></i>全选
                        </button>
                        <button class="btn btn-sm btn-primary" id="fixSelectedUrls">
                            <i class="fas fa-wrench me-1"></i>修复选中
                        </button>
                    </div>
                </div>
            `;
            
            // 添加每个错误项
            urlErrorsToFix.forEach((error, index) => {
                const errorItem = document.createElement('div');
                errorItem.className = 'p-3 border rounded mb-2 bg-white';
                errorItem.innerHTML = `
                    <div class="d-flex align-items-start">
                        <input type="checkbox" class="form-check-input mt-1 me-2 url-error-checkbox" id="urlError${index}" checked>
                        <div class="flex-grow-1">
                            <div class="text-danger font-medium mb-1">错误: ${error.errors.join(', ')}</div>
                            <div class="text-sm">
                                <span class="text-muted">原URL:</span> <code class="text-sm">${error.originalUrl}</code><br>
                                <span class="text-muted">修复后:</span> <code class="text-sm text-success">${error.fixedUrl}</code>
                            </div>
                        </div>
                    </div>
                `;
                urlErrorsContent.appendChild(errorItem);
            });
            
            // 绑定全选按钮事件
            document.getElementById('selectAllUrlErrors').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.url-error-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
            });
            
            // 绑定修复选中按钮事件
            document.getElementById('fixSelectedUrls').addEventListener('click', function() {
                applyUrlFixesFromMainArea();
            });
            

        }
        
        // 从主界面应用URL修复
        function applyUrlFixesFromMainArea() {
            let fixedCount = 0;
            
            urlErrorsToFix.forEach((error, index) => {
                const checkbox = document.getElementById(`urlError${index}`);
                if (checkbox && checkbox.checked) {
                    // 应用修复
                    if (error.isSpecial) {
                        // 修复特殊栏目网站
                        navData.more.special.sites[error.siteIndex].url = error.fixedUrl;
                    } else {
                        // 修复普通选项卡网站
                        navData[error.page].tabs[error.tabIndex].items[error.siteIndex].url = error.fixedUrl;
                    }
                    fixedCount++;
                    
                    // 移除已修复的错误项
                    const errorItem = checkbox.closest('.p-3.border.rounded.mb-2.bg-white');
                    if (errorItem) {
                        errorItem.remove();
                    }
                }
            });
            
            if (fixedCount > 0) {
                showAlert(`成功修复${fixedCount}个URL错误`, 'success');
                addLogEntry(`修复了${fixedCount}个URL错误`, LOG_TYPES.SUCCESS);
                
                // 更新错误计数
                urlErrorsToFix = urlErrorsToFix.filter((error, index) => {
                    const checkbox = document.getElementById(`urlError${index}`);
                    return !(checkbox && checkbox.checked);
                });
                
                // 如果没有错误了，更新显示
                const urlErrorsContent = document.getElementById('urlErrorsContent');
                if (urlErrorsToFix.length === 0 && urlErrorsContent) {
                    urlErrorsContent.innerHTML = '<div class="text-center text-success py-2">未发现URL错误</div>';
                } else if (urlErrorsContent) {
                    // 更新错误计数显示
                    const errorCountElement = urlErrorsContent.querySelector('.text-danger.font-medium');
                    if (errorCountElement) {
                        errorCountElement.textContent = `发现 ${urlErrorsToFix.length} 个URL错误`;
                    }
                }
            }
        }
        
        // 在模态框中显示URL错误结果
        function displayUrlErrors() {
            const urlCheckResults = document.getElementById('urlCheckResults');
            if (!urlCheckResults) return;
            
            urlCheckResults.innerHTML = '';
            
            urlErrorsToFix.forEach((error, index) => {
                const errorCard = document.createElement('div');
                errorCard.className = 'p-3 border rounded mb-2';
                errorCard.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" class="form-check-input me-2" id="fixUrl${index}" checked>
                        <div class="flex-grow-1">
                            <div class="text-danger mb-1">错误: ${error.errors.join(', ')}</div>
                            <div class="text-sm text-muted">原URL: <code>${error.originalUrl}</code></div>
                            <div class="text-sm text-success">修复后: <code>${error.fixedUrl}</code></div>
                        </div>
                    </div>
                `;
                urlCheckResults.appendChild(errorCard);
            });
        }
        
        // 应用URL修复
        function applyUrlFixes() {
            let fixedCount = 0;
            
            urlErrorsToFix.forEach((error, index) => {
                const checkbox = document.getElementById(`fixUrl${index}`);
                if (checkbox && checkbox.checked) {
                    // 应用修复
                    if (error.isSpecial) {
                        // 修复特殊栏目网站
                        navData.more.special.sites[error.siteIndex].url = error.fixedUrl;
                    } else {
                        // 修复普通选项卡网站
                        navData[error.page].tabs[error.tabIndex].items[error.siteIndex].url = error.fixedUrl;
                    }
                    fixedCount++;
                }
            });
            
            if (fixedCount > 0) {
                showAlert(`成功修复${fixedCount}个URL错误`, 'success');
                addLogEntry(`修复了${fixedCount}个URL错误`, LOG_TYPES.SUCCESS);
                // 标记数据已修改
                setDataChanged();
                // 刷新页面显示
                renderCurrentPage();
            }
            
            urlFixModal.hide();
        }
        
        // 检查网站可访问性
        async function checkWebsitesAccessibility() {
            if (!navData || Object.keys(navData).length === 0) {
                showAlert('请先加载导航数据', 'warning');
                return;
            }
            
            showAlert('开始检查网站可访问性，请耐心等待...', 'info');
            addLogEntry('开始检查网站可访问性', LOG_TYPES.INFO);
            
            let totalSites = 0;
            let accessibleSites = 0;
            let inaccessibleSites = [];
            
            // 收集所有网站URL
            const allSites = [];
            
            // 收集普通选项卡中的网站
            Object.keys(navData).forEach(page => {
                if (navData[page] && navData[page].tabs) {
                    navData[page].tabs.forEach((tab, tabIndex) => {
                        if (tab.items) {
                            tab.items.forEach((site, siteIndex) => {
                                if (site.url) {
                                    allSites.push({
                                        ...site,
                                        page,
                                        tabIndex,
                                        siteIndex,
                                        isSpecial: false
                                    });
                                    totalSites++;
                                }
                            });
                        }
                    });
                }
            });
            
            // 收集特殊栏目中的网站
            if (navData.more && navData.more.special && navData.more.special.sites) {
                navData.more.special.sites.forEach((site, siteIndex) => {
                    if (site.url) {
                        allSites.push({
                            ...site,
                            page: 'more',
                            siteIndex,
                            isSpecial: true
                        });
                        totalSites++;
                    }
                });
            }
            
            // 批量检查可访问性（控制并发数）
            const concurrencyLimit = 5;
            const batches = [];
            
            for (let i = 0; i < allSites.length; i += concurrencyLimit) {
                batches.push(allSites.slice(i, i + concurrencyLimit));
            }
            
            // 逐个批次检查
            for (const batch of batches) {
                const batchPromises = batch.map(site => checkSiteAccessibility(site));
                const batchResults = await Promise.allSettled(batchPromises);
                
                batchResults.forEach((result, index) => {
                    const site = batch[index];
                    if (result.status === 'fulfilled' && result.value) {
                        accessibleSites++;
                    } else {
                        inaccessibleSites.push(site);
                    }
                });
                
                // 每批之间等待1秒，避免请求过快
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // 显示结果
            const message = `可访问性检查完成: 总计${totalSites}个网站，${accessibleSites}个可访问，${inaccessibleSites.length}个不可访问`;
            showAlert(message, inaccessibleSites.length > 0 ? 'warning' : 'success');
            
            // 记录日志
            addLogEntry('网站可访问性检查完成', LOG_TYPES.INFO, message);
            
            if (inaccessibleSites.length > 0) {
                let details = '不可访问的网站：\n';
                inaccessibleSites.forEach(site => {
                    details += `- ${site.name}: ${site.url}\n`;
                });
                addLogEntry(`发现${inaccessibleSites.length}个不可访问的网站`, LOG_TYPES.WARNING, details);
            }
        }
        
        // 检查单个网站的可访问性
        async function checkSiteAccessibility(site) {
            try {
                // 使用HEAD请求检查网站是否可访问（更轻量）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch(site.url, {
                    method: 'HEAD',
                    mode: 'cors',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        // 检测搜索引擎Ping值
        async function pingSearchEngines() {
            const searchEngines = [
                { name: '百度', url: 'https://www.baidu.com' },
                { name: '谷歌', url: 'https://www.google.com' },
                { name: '必应', url: 'https://www.bing.com' },
                { name: '搜狗', url: 'https://www.sogou.com' },
                { name: '360搜索', url: 'https://www.so.com' }
            ];
            
            // 获取pingResults元素
            const pingResults = document.getElementById('pingResults');
            if (!pingResults) {
                showAlert('未找到Ping值显示元素', 'error');
                return;
            }
            
            // 显示加载状态
            const pingItems = pingResults.querySelector('.ping-items');
            if (pingItems) {
                pingItems.innerHTML = '<div class="text-center py-2"><i class="fas fa-spinner fa-spin"></i> 正在检测...</div>';
            }
            
            pingResults.classList.remove('d-none');
            
            // 开始检测
            const pingResultsList = [];
            
            for (const engine of searchEngines) {
                const startTime = performance.now();
                try {
                    // 使用CORS代理服务来绕过跨域限制
                    // 注意：实际使用时可能需要更换为更可靠的代理服务
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(engine.url);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 延长超时时间到5秒
                    
                    await fetch(proxyUrl, {
                        method: 'GET', // 使用GET而不是HEAD，有些代理可能不支持HEAD
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    const endTime = performance.now();
                    const pingTime = Math.round(endTime - startTime);
                    
                    pingResultsList.push({
                        ...engine,
                        ping: pingTime,
                        success: true
                    });
                    
                    addLogEntry(`成功检测${engine.name}Ping值`, LOG_TYPES.SUCCESS, `耗时: ${pingTime}ms`);
                } catch (error) {
                    let errorMessage = '请求失败';
                    if (error.name === 'AbortError') {
                        errorMessage = '请求超时';
                    }
                    
                    pingResultsList.push({
                        ...engine,
                        ping: -1,
                        success: false
                    });
                    
                    addLogEntry(`检测${engine.name}Ping值失败`, LOG_TYPES.WARNING, errorMessage);
                }
                
                // 更新显示
                updatePingResults(pingResultsList);
                
                // 避免请求过快
                await new Promise(resolve => setTimeout(resolve, 800));
            }
            
            const successCount = pingResultsList.filter(r => r.success).length;
            addLogEntry(`搜索引擎Ping值检测完成`, LOG_TYPES.INFO, `${successCount}/${searchEngines.length}个成功`);
            
            // 提示用户检查结果
            if (successCount > 0) {
                showAlert(`成功检测到${successCount}个搜索引擎的连接速度`, 'success');
            } else {
                showAlert('所有搜索引擎连接检测失败，可能是代理服务问题或网络限制', 'warning');
            }
        }
        
        // 更新Ping值显示
        function updatePingResults(results) {
            const pingItems = pingResults.querySelector('.ping-items');
            if (!pingItems) return;
            
            pingItems.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'd-flex justify-content-between align-items-center py-1 border-b';
                
                let pingDisplay;
                let pingClass;
                
                if (result.success) {
                    pingDisplay = `${result.ping} ms`;
                    if (result.ping < 100) {
                        pingClass = 'text-success';
                    } else if (result.ping < 300) {
                        pingClass = 'text-warning';
                    } else {
                        pingClass = 'text-danger';
                    }
                } else {
                    pingDisplay = '超时';
                    pingClass = 'text-danger';
                }
                
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-search me-2"></i>
                        <span>${result.name}</span>
                    </div>
                    <span class="${pingClass} font-medium">${pingDisplay}</span>
                `;
                pingItems.appendChild(item);
            });
        }
        
        // 初始化添加选项卡按钮的新交互
        function setupAddTabButton() {
            const addTabBtn = document.getElementById('addTabBtn');
            let isEditing = false;
            let inputElement = null;
            
            // 点击按钮时显示输入框
            addTabBtn.addEventListener('click', function(e) {
                if (isEditing) {
                    // 如果已经处于编辑模式，保存输入
                    saveNewTab();
                } else {
                    // 切换到编辑模式
                    enableTabEditMode();
                }
            });
            
            // 启用选项卡编辑模式
            function enableTabEditMode() {
                if (isEditing) return;
                
                isEditing = true;
                
                // 创建输入框元素
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.placeholder = '输入选项卡名称';
                inputElement.className = 'tab-name-input';
                inputElement.style.cssText = `
                    position: absolute;
                    right: 100%;
                    margin-right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 160px;
                    padding: 5px 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 14px;
                    outline: none;
                    background-color: #fff;
                    z-index: 1000;
                `;
                
                // 将输入框添加到按钮容器中
                // 确保按钮容器有相对定位
                if (addTabBtn.parentNode.style.position !== 'absolute' && addTabBtn.parentNode.style.position !== 'relative') {
                    addTabBtn.parentNode.style.position = 'relative';
                }
                addTabBtn.parentNode.appendChild(inputElement);
                
                // 更改按钮文本为"完成"
                addTabBtn.textContent = '完成';
                
                // 聚焦输入框
                setTimeout(() => inputElement.focus(), 100);
                
                // 添加键盘事件监听
                inputElement.addEventListener('keydown', handleKeyDown);
                
                // 添加失焦事件监听（自动保存）
                inputElement.addEventListener('blur', handleBlur);
                
                // 防止点击按钮时输入框失焦
                addTabBtn.addEventListener('click', preventInputBlur);
                
                // 全局点击事件，点击其他地方时保存
                document.addEventListener('click', handleDocumentClick);
            }
            
            // 处理键盘事件
            function handleKeyDown(e) {
                if (e.key === 'Enter') {
                    // 按Enter键保存
                    saveNewTab();
                } else if (e.key === 'Escape') {
                    // 按Esc键取消编辑
                    cancelTabEdit();
                }
            }
            
            // 处理失焦事件
            function handleBlur() {
                // 失焦时自动保存
                setTimeout(() => {
                    if (isEditing) {
                        saveNewTab();
                    }
                }, 200);
            }
            
            // 防止点击按钮时输入框失焦
            function preventInputBlur(e) {
                e.stopPropagation();
            }
            
            // 处理文档点击事件
            function handleDocumentClick(e) {
                // 点击按钮或输入框以外的区域时，保存并退出编辑模式
                if (!addTabBtn.contains(e.target) && e.target !== inputElement) {
                    saveNewTab();
                }
            }
            
            // 保存新选项卡
            function saveNewTab() {
                if (!isEditing || !inputElement) return;
                
                const tabName = inputElement.value.trim();
                
                if (tabName) {
                    // 使用现有的addNewTab函数添加选项卡
                    addNewTabWithName(tabName);
                    
                    // 记录操作日志
                    addLogEntry(`添加选项卡: ${tabName}`);
                    
                    // 显示成功提示
                    showSuccessToast(`选项卡 "${tabName}" 添加成功`);
                }
                
                // 清理并退出编辑模式
                cleanupEditMode();
            }
            
            // 取消选项卡编辑
            function cancelTabEdit() {
                cleanupEditMode();
            }
            
            // 清理编辑模式
            function cleanupEditMode() {
                if (!isEditing) return;
                
                // 移除事件监听
                inputElement?.removeEventListener('keydown', handleKeyDown);
                inputElement?.removeEventListener('blur', handleBlur);
                addTabBtn.removeEventListener('click', preventInputBlur);
                document.removeEventListener('click', handleDocumentClick);
                
                // 移除输入框
                if (inputElement && inputElement.parentNode) {
                    inputElement.parentNode.removeChild(inputElement);
                }
                
                // 恢复按钮文本
                addTabBtn.textContent = '+ 添加选项卡';
                
                // 重置状态
                isEditing = false;
                inputElement = null;
            }
            
            // 添加新选项卡的函数（基于现有的addNewTab函数逻辑）
            function addNewTabWithName(tabName) {
                // 检查选项卡名称是否已存在
                const isDuplicate = navData.tabs.some(tab => tab.name === tabName);
                if (isDuplicate) {
                    alert('选项卡名称已存在，请使用其他名称');
                    return;
                }
                
                // 创建新选项卡对象
                const newTab = {
                    id: Date.now().toString(),
                    name: tabName,
                    sites: []
                };
                
                // 添加到数据中
                navData.tabs.push(newTab);
                
                // 刷新选项卡显示
                renderTabs();
                
                // 自动切换到新添加的选项卡
                selectTab(newTab.id);
                
                // 标记数据已修改
                setDataChanged();
            }
        }
        
        // 显示成功提示
        function showSuccessToast(message) {
            // 创建toast元素
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background-color: #4CAF50;
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // 页面加载时添加初始日志
        addLogEntry('导航数据管理系统已启动', LOG_TYPES.INFO, '系统初始化完成');
        
        // PWA Service Worker注册
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../../service-worker.js')
                    .then(registration => {
                        console.log('Service Worker 注册成功:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>
</html>