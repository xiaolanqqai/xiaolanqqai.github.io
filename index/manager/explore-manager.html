<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>探索网页系统</title>
    
    <!-- 模块化 Header 组件 -->
    <script src="../../js/components/header-component.js"></script>
    
    <!-- 引入通用脚本 -->
    <script src="../../js/manager-common.js"></script>
    <script src="../../js/github-api-helper.js"></script>
</head>
<body class="manager-body">
    <!-- 返回首页按钮 -->
    <a href="../../index.html" class="home-button" title="返回首页">
        <i class="fas fa-home"></i>
    </a>
    
    <!-- 管理页面导航栏 -->
    <div class="manager-nav">
        <a href="nav-manager.html" class="manager-nav-button" title="导航数据管理">
            <i class="fas fa-sitemap"></i>
        </a>
        <a href="MM-generator.html" class="manager-nav-button" title="密码生成器">
            <i class="fas fa-key"></i>
        </a>
        <a href="vol-manager.html" class="manager-nav-button" title="版本管理">
            <i class="fas fa-code-branch"></i>
        </a>
        <a href="explore-manager.html" class="manager-nav-button active" title="探索网页">
            <i class="fas fa-compass"></i>
        </a>
        <!-- 操作日志按钮 -->
        <button class="manager-nav-button bg-warning" title="操作日志" data-bs-toggle="offcanvas" data-bs-target="#logOffcanvas">
            <i class="fas fa-exclamation-circle"></i>
        </button>
    </div>
    
    <div class="manager-header explore-header header-gradient py-4 mb-4">
        <div class="container">
            <h1 class="text-center mb-2 text-light">探索网页系统</h1>
            <p class="text-center mb-0 text-light opacity-75">发现新的有趣网站，开拓您的网络视野</p>
        </div>
    </div>
    
    <div class="container container-main">
        <!-- GitHub 同步功能卡片 -->
        <div class="manager-card mb-4 border-primary">
            <div class="manager-card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fab fa-github me-2"></i>GitHub 云端同步</h5>
            </div>
            <div class="manager-card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-0 text-muted small">
                            直接同步发现的网站数据和您的个人收藏到 GitHub 仓库。
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="syncToGithubBtn" class="btn btn-primary">
                            <i class="fas fa-cloud-upload-alt me-1"></i> 立即同步
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 标签页切换 -->
        <div class="mb-4">
            <ul class="nav nav-tabs" id="exploreTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="favorites-tab" data-bs-toggle="tab" data-bs-target="#favorites" type="button" role="tab" aria-controls="favorites" aria-selected="true">我的收藏</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trending-tab" data-bs-toggle="tab" data-bs-target="#trending" type="button" role="tab" aria-controls="trending" aria-selected="false">热门</button>
                </li>
            </ul>
        </div>
        
        <!-- 工具箱模块 -->
        <div class="manager-card mb-4">
            <div class="manager-card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bookmark me-2"></i>浏览器收藏夹</h5>
                <button id="refreshBookmarks" class="btn btn-sm btn-light">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
            <div class="manager-card-body">
                <p class="text-muted mb-3 small">以下是您浏览器中的收藏网站，按文件夹分类显示：</p>
                
                <!-- 收藏夹内容将由JavaScript动态生成 -->
                <div id="bookmarksContainer">
                    <div class="text-center py-5">
                        <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                        <p class="text-muted">点击上方刷新按钮加载浏览器收藏夹</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分类过滤 -->
        <div class="mb-4">
            <h6 class="mb-3 text-muted small"><i class="fas fa-filter me-2"></i>按分类发现</h6>
            <div class="tag-cloud" id="categoryFilter">
                <a href="#" class="category-tag active" data-category="all">全部</a>
                <a href="#" class="category-tag" data-category="tools">工具</a>
                <a href="#" class="category-tag" data-category="entertainment">娱乐</a>
                <a href="#" class="category-tag" data-category="education">教育</a>
                <a href="#" class="category-tag" data-category="productivity">生产力</a>
                <a href="#" class="category-tag" data-category="design">设计</a>
                <a href="#" class="category-tag" data-category="programming">编程</a>
                <a href="#" class="category-tag" data-category="news">新闻</a>
                <a href="#" class="category-tag" data-category="social">社交</a>
                <a href="#" class="category-tag" data-category="other">其他</a>
            </div>
        </div>
        
        <!-- 标签页内容 -->
        <div class="tab-content border-0 p-0 bg-transparent" id="exploreTabContent">
            
            <!-- 热门标签页 -->
            <div class="tab-pane fade" id="trending" role="tabpanel" aria-labelledby="trending-tab">
                <div class="list-group shadow-sm" id="trendingList">
                    <!-- 热门网站列表将由JavaScript动态生成 -->
                    <!-- 骨架屏加载状态 -->
                    <div class="list-group-item p-4">
                        <div class="skeleton h-20px w-50p mb-2"></div>
                        <div class="skeleton h-16px w-80p"></div>
                    </div>
                    <div class="list-group-item p-4">
                        <div class="skeleton h-20px w-50p mb-2"></div>
                        <div class="skeleton h-16px w-80p"></div>
                    </div>
                    <div class="list-group-item p-4">
                        <div class="skeleton h-20px w-50p mb-2"></div>
                        <div class="skeleton h-16px w-80p"></div>
                    </div>
                </div>
            </div>
            
            <!-- 收藏标签页 -->
            <div class="tab-pane fade show active" id="favorites" role="tabpanel" aria-labelledby="favorites-tab">
                <div class="favorites-list" id="favoritesList">
                    <div class="alert alert-info text-center p-5">
                        <i class="fas fa-star text-warning mb-3 fs-1"></i>
                        <h4>还没有收藏网站</h4>
                        <p class="mb-0">浏览"发现"或"热门"标签页，点击星标图标收藏您喜欢的网站</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 添加网站按钮 -->
        <div class="text-center mt-5 mb-4">
            <button class="btn btn-lg btn-discover px-4" data-bs-toggle="modal" data-bs-target="#addSiteModal">
                <i class="fas fa-plus me-2"></i>添加您发现的网站
            </button>
        </div>
    </div>
    
    <!-- 页脚 -->
    <div class="manager-footer py-3 mt-4">
        <div class="container text-center">
            <p class="mb-1 text-muted">探索网页系统 &copy; 2023 Xiaolan</p>
            <p class="mb-0"><a href="../../index.html" class="text-decoration-none">返回主页</a></p>
        </div>
    </div>
    
    <!-- 添加网站模态框 -->
    <div class="modal fade" id="addSiteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新网站</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addSiteForm">
                        <div class="mb-3">
                            <label for="siteName" class="form-label">网站名称</label>
                            <input type="text" class="form-control" id="siteName" placeholder="输入网站名称" required>
                        </div>
                        <div class="mb-3">
                            <label for="siteUrl" class="form-label">网站链接</label>
                            <input type="url" class="form-control" id="siteUrl" placeholder="https://" required>
                        </div>
                        <div class="mb-3">
                            <label for="siteDescription" class="form-label">网站描述</label>
                            <textarea class="form-control" id="siteDescription" rows="3" placeholder="简要描述这个网站的特点和用途" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="siteCategory" class="form-label">网站分类</label>
                            <select class="form-select" id="siteCategory" required>
                                <option value="">请选择分类</option>
                                <option value="tools">工具</option>
                                <option value="entertainment">娱乐</option>
                                <option value="education">教育</option>
                                <option value="productivity">生产力</option>
                                <option value="design">设计</option>
                                <option value="programming">编程</option>
                                <option value="news">新闻</option>
                                <option value="social">社交</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="siteImageUrl" class="form-label">网站预览图URL (可选)</label>
                            <input type="url" class="form-control" id="siteImageUrl" placeholder="https://">
                            <div class="form-text">没有预览图时会自动生成</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-discover" id="submitSiteButton">添加网站</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 网站详情模态框 -->
    <div class="modal fade" id="siteDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalTitle">网站详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <img id="detailModalImage" src="" alt="网站预览" class="img-fluid rounded mb-3">
                            <div class="mt-2">
                                <a id="detailModalVisit" href="" target="_blank" class="btn btn-discover w-100">
                                    <i class="fas fa-external-link-alt"></i> 访问网站
                                </a>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h4 id="detailModalName" class="mb-2"></h4>
                            <div id="detailModalCategories" class="mb-3"></div>
                            <p id="detailModalDescription" class="mb-3"></p>
                            <div class="mb-2">
                                <span class="text-muted">访问量: </span>
                                <span id="detailModalVisits">0</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">评分: </span>
                                <span id="detailModalRating" class="site-rating">☆☆☆☆☆</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">添加时间: </span>
                                <span id="detailModalDate"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 探索网页系统JavaScript -->
    <script>
        // 快捷访问 managerCommon
        const common = window.managerCommon || (typeof ManagerCommon !== 'undefined' ? new ManagerCommon() : null);
        if (common && !window.managerCommon) window.managerCommon = common;

        document.addEventListener('DOMContentLoaded', function() {
            // 初始化模态框
            const addSiteModal = new bootstrap.Modal(document.getElementById('addSiteModal'));
            const siteDetailModal = new bootstrap.Modal(document.getElementById('siteDetailModal'));
            
            // 清空日志
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', () => {
                    if (confirm('确定要清空所有操作日志吗？')) {
                        common.clearLogs();
                    }
                });
            }

            // GitHub 相关逻辑
            const syncToGithubBtn = document.getElementById('syncToGithubBtn');

            // 同步到 GitHub
            syncToGithubBtn.addEventListener('click', async function() {
                if (!common) return;
                try {
                    const data = {
                        sites: mockSites,
                        favorites: favorites,
                        lastUpdated: new Date().toISOString()
                    };
                    await common.syncToGithub('data/explore-data.json', data);
                } catch (error) {
                    // 错误已由 common.syncToGithub 处理
                }
            });

            // 从 GitHub 加载数据
            async function loadFromGithub() {
                try {
                    const path = 'data/explore-data.json';
                    const response = await window.githubHelper.getFile(path);
                    if (response && response.content) {
                        const decodedContent = decodeURIComponent(escape(atob(response.content)));
                        const data = JSON.parse(decodedContent);
                        
                        if (data.sites) {
                            mockSites.length = 0;
                            mockSites.push(...data.sites);
                        }
                        
                        if (data.favorites) {
                            favorites.length = 0;
                            favorites.push(...data.favorites);
                            localStorage.setItem('explore-favorites', JSON.stringify(favorites));
                        }
                        
                        renderDiscoverCards(mockSites);
                        renderTrendingList(mockSites);
                        renderFavorites();
                        
                        common.log('从 GitHub 加载数据成功', 'success');
                    }
                } catch (error) {
                    console.error('从 GitHub 加载数据失败:', error);
                    // 如果文件不存在，这是正常的（第一次同步前）
                    if (error.status !== 404) {
                        common.log('从 GitHub 加载数据失败', 'error', error.message);
                    }
                }
            }

            // 模拟数据 - 在实际应用中应该从API获取
            const mockSites = [
                {
                    id: 1,
                    name: "Canva",
                    url: "https://www.canva.com",
                    description: "简单易用的图形设计工具，无需专业技能即可创建精美的设计作品。",
                    category: ["design", "tools"],
                    imageUrl: "https://example.com/canva.jpg",
                    visits: 1254,
                    rating: 4.8,
                    addedDate: "2023-05-15"
                },
                {
                    id: 2,
                    name: "GitHub",
                    url: "https://github.com",
                    description: "全球最大的开源代码托管平台，程序员必备的协作开发工具。",
                    category: ["programming", "productivity"],
                    imageUrl: "https://example.com/github.jpg",
                    visits: 5621,
                    rating: 4.9,
                    addedDate: "2023-04-20"
                },
                {
                    id: 3,
                    name: "Khan Academy",
                    url: "https://www.khanacademy.org",
                    description: "免费的在线教育平台，提供各种学科的视频课程和练习。",
                    category: ["education"],
                    imageUrl: "https://example.com/khan.jpg",
                    visits: 876,
                    rating: 4.7,
                    addedDate: "2023-06-10"
                },
                {
                    id: 4,
                    name: "Bilibili",
                    url: "https://www.bilibili.com",
                    description: "国内知名的视频弹幕网站，拥有丰富的动画、游戏、音乐等内容。",
                    category: ["entertainment", "social"],
                    imageUrl: "https://example.com/bilibili.jpg",
                    visits: 3421,
                    rating: 4.6,
                    addedDate: "2023-05-25"
                },
                {
                    id: 5,
                    name: "TinyPNG",
                    url: "https://tinypng.com",
                    description: "智能压缩图片的在线工具，保持图片质量的同时减小文件大小。",
                    category: ["tools", "design"],
                    imageUrl: "https://example.com/tinypng.jpg",
                    visits: 987,
                    rating: 4.5,
                    addedDate: "2023-06-05"
                },
                {
                    id: 6,
                    name: "MDN Web Docs",
                    url: "https://developer.mozilla.org",
                    description: "Mozilla提供的权威Web开发文档，涵盖HTML、CSS、JavaScript等技术。",
                    category: ["programming", "education"],
                    imageUrl: "https://example.com/mdn.jpg",
                    visits: 2154,
                    rating: 4.9,
                    addedDate: "2023-04-15"
                }
            ];
            
            // 获取本地存储的收藏网站
            let favorites = JSON.parse(localStorage.getItem('explore-favorites')) || [];
            
            // 渲染发现页面卡片
            function renderDiscoverCards(sites) {
                const container = document.getElementById('discoverResults');
                container.innerHTML = '';
                
                sites.forEach(site => {
                    const isFavorite = favorites.some(fav => fav.id === site.id);
                    const card = createSiteCard(site, isFavorite);
                    container.appendChild(card);
                });
            }
            
            // 创建网站卡片
            function createSiteCard(site, isFavorite) {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-4';
                
                col.innerHTML = `
                    <div class="discover-card shadow">
                        <img src="${site.imageUrl || 'https://via.placeholder.com/400x225?text=' + encodeURIComponent(site.name)}" class="card-img-top" alt="${site.name}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">${site.name}</h5>
                                <i class="fas fa-star favorites-icon ${isFavorite ? 'active' : ''}" data-id="${site.id}"></i>
                            </div>
                            <div class="mb-2">
                                ${site.category.map(cat => `<span class="category-pill">${getCategoryName(cat)}</span>`).join('')}
                            </div>
                            <p class="card-text text-muted">${site.description}</p>
                            <div class="d-flex justify-content-between mt-3">
                                <span class="site-rating">${generateRatingStars(site.rating)}</span>
                                <span class="text-sm text-muted">${site.visits} 次访问</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加卡片点击事件
                col.querySelector('.discover-card').addEventListener('click', (e) => {
                    // 如果点击的是收藏图标，不打开详情
                    if (e.target.classList.contains('favorites-icon')) return;
                    showSiteDetail(site);
                });
                
                // 添加收藏图标点击事件
                col.querySelector('.favorites-icon').addEventListener('click', (e) => {
                    e.stopPropagation(); // 阻止事件冒泡
                    toggleFavorite(site);
                    e.target.classList.toggle('active');
                });
                
                return col;
            }
            
            // 渲染热门网站列表
            function renderTrendingList(sites) {
                const container = document.getElementById('trendingList');
                container.innerHTML = '';
                
                // 按访问量排序
                const sortedSites = [...sites].sort((a, b) => b.visits - a.visits);
                
                sortedSites.forEach(site => {
                    const isFavorite = favorites.some(fav => fav.id === site.id);
                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item p-4';
                    
                    listItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${site.name}</h5>
                                <p class="mb-0 text-muted">${site.description}</p>
                            </div>
                            <i class="fas fa-star favorites-icon ${isFavorite ? 'active' : ''}" data-id="${site.id}"></i>
                        </div>
                    `;
                    
                    // 添加点击事件
                    listItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('favorites-icon')) {
                            showSiteDetail(site);
                        }
                    });
                    
                    // 添加收藏图标点击事件
                    listItem.querySelector('.favorites-icon').addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleFavorite(site);
                        e.target.classList.toggle('active');
                    });
                    
                    container.appendChild(listItem);
                });
            }
            
            // 渲染收藏列表
            function renderFavorites() {
                const container = document.getElementById('favoritesList');
                
                if (favorites.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info text-center p-5">
                            <i class="fas fa-star text-warning mb-2 fs-3r"></i>
                            <h4 class="mt-2">还没有收藏网站</h4>
                            <p class="mb-0">浏览"发现"或"热门"标签页，点击星标图标收藏您喜欢的网站</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                favorites.forEach(site => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item favorites-list-item p-4';
                    
                    listItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${site.name}</h5>
                                <p class="mb-0 text-muted">${site.description}</p>
                            </div>
                            <div>
                                <a href="${site.url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger remove-favorite" data-id="${site.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 添加点击事件
                    listItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button') && !e.target.closest('a')) {
                            showSiteDetail(site);
                        }
                    });
                    
                    // 添加移除收藏点击事件
                    listItem.querySelector('.remove-favorite').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFavorite(site.id);
                        renderFavorites();
                        // 同时更新其他标签页中的收藏状态
                        updateFavoriteIcons();
                    });
                    
                    container.appendChild(listItem);
                });
            }
            
            // 显示网站详情
            function showSiteDetail(site) {
                document.getElementById('detailModalTitle').textContent = site.name;
                document.getElementById('detailModalName').textContent = site.name;
                document.getElementById('detailModalDescription').textContent = site.description;
                document.getElementById('detailModalImage').src = site.imageUrl || 'https://via.placeholder.com/400x225?text=' + encodeURIComponent(site.name);
                document.getElementById('detailModalImage').alt = site.name;
                document.getElementById('detailModalVisit').href = site.url;
                document.getElementById('detailModalVisits').textContent = site.visits;
                document.getElementById('detailModalRating').textContent = generateRatingStars(site.rating);
                document.getElementById('detailModalDate').textContent = site.addedDate;
                
                // 设置分类标签
                const categoriesContainer = document.getElementById('detailModalCategories');
                categoriesContainer.innerHTML = '';
                site.category.forEach(cat => {
                    const pill = document.createElement('span');
                    pill.className = 'category-pill';
                    pill.textContent = getCategoryName(cat);
                    categoriesContainer.appendChild(pill);
                });
                
                // 打开模态框
                siteDetailModal.show();
                
                // 增加访问次数
                site.visits += 1;
            }
            
            // 切换收藏状态
            function toggleFavorite(site) {
                const index = favorites.findIndex(fav => fav.id === site.id);
                
                if (index === -1) {
                    // 添加到收藏
                    favorites.push(site);
                    common.showAlert(`已将${site.name}添加到收藏`);
                } else {
                    // 从收藏中移除
                    favorites.splice(index, 1);
                    common.showAlert(`已从收藏中移除${site.name}`);
                }
                
                // 保存到本地存储
                localStorage.setItem('explore-favorites', JSON.stringify(favorites));
                
                // 更新收藏标签页
                if (document.getElementById('favorites-tab').classList.contains('active')) {
                    renderFavorites();
                }
            }
            
            // 移除收藏
            function removeFavorite(siteId) {
                favorites = favorites.filter(fav => fav.id !== siteId);
                localStorage.setItem('explore-favorites', JSON.stringify(favorites));
                common.showAlert('已从收藏中移除');
            }
            
            // 更新所有收藏图标的状态
            function updateFavoriteIcons() {
                document.querySelectorAll('.favorites-icon').forEach(icon => {
                    const siteId = parseInt(icon.getAttribute('data-id'));
                    const isFavorite = favorites.some(fav => fav.id === siteId);
                    icon.classList.toggle('active', isFavorite);
                });
            }
            
            // 生成评分星星
            function generateRatingStars(rating) {
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                
                let stars = '★'.repeat(fullStars);
                if (hasHalfStar) stars += '½';
                stars += '☆'.repeat(emptyStars);
                
                return stars;
            }
            
            // 获取分类的中文名称
            function getCategoryName(category) {
                const categoryMap = {
                    'tools': '工具',
                    'entertainment': '娱乐',
                    'education': '教育',
                    'productivity': '生产力',
                    'design': '设计',
                    'programming': '编程',
                    'news': '新闻',
                    'social': '社交',
                    'other': '其他'
                };
                
                return categoryMap[category] || category;
            }
            
            // 搜索功能
            function initSearch() {
                const searchInput = document.getElementById('searchInput');
                const searchButton = document.getElementById('searchButton');
                
                function performSearch() {
                    const query = searchInput.value.toLowerCase().trim();
                    if (!query) {
                        renderDiscoverCards(mockSites);
                        return;
                    }
                    
                    const results = mockSites.filter(site => 
                        site.name.toLowerCase().includes(query) ||
                        site.description.toLowerCase().includes(query) ||
                        site.category.some(cat => getCategoryName(cat).toLowerCase().includes(query))
                    );
                    
                    renderDiscoverCards(results);
                }
                
                searchButton.addEventListener('click', performSearch);
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
            }
            
            // 分类过滤功能
            function initCategoryFilter() {
                const categoryTags = document.querySelectorAll('.category-tag');
                
                categoryTags.forEach(tag => {
                    tag.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // 更新活动标签样式
                        categoryTags.forEach(t => t.classList.remove('active'));
                        tag.classList.add('active');
                        
                        const category = tag.getAttribute('data-category');
                        
                        if (category === 'all') {
                            renderDiscoverCards(mockSites);
                        } else {
                            const filtered = mockSites.filter(site => site.category.includes(category));
                            renderDiscoverCards(filtered);
                        }
                    });
                });
            }
            
            // 随机发现功能
            function initRandomDiscover() {
                const randomButton = document.getElementById('randomButton');
                
                randomButton.addEventListener('click', () => {
                    const randomIndex = Math.floor(Math.random() * mockSites.length);
                    showSiteDetail(mockSites[randomIndex]);
                });
            }
            
            // 加载更多功能
            function initLoadMore() {
                const loadMoreButton = document.getElementById('loadMoreButton');
                
                loadMoreButton.addEventListener('click', () => {
                    // 模拟加载更多数据
                    loadMoreButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中...';
                    
                    setTimeout(() => {
                        // 复制现有数据模拟加载更多
                        const moreSites = mockSites.map(site => ({
                            ...site,
                            id: site.id + mockSites.length, // 生成新ID
                            name: site.name + ' (推荐)',
                            visits: Math.floor(Math.random() * 2000) + 100
                        }));
                        
                        // 追加到现有卡片
                        const container = document.getElementById('discoverResults');
                        moreSites.forEach(site => {
                            const isFavorite = favorites.some(fav => fav.id === site.id);
                            const card = createSiteCard(site, isFavorite);
                            container.appendChild(card);
                        });
                        
                        loadMoreButton.innerHTML = '<i class="fas fa-spinner"></i> 加载更多';
                        loadMoreButton.disabled = true;
                        loadMoreButton.textContent = '没有更多了';
                        common.showAlert('已加载更多推荐网站');
                    }, 1500);
                });
            }
            
            // 添加网站表单处理
            function initAddSiteForm() {
                const submitButton = document.getElementById('submitSiteButton');
                
                submitButton.addEventListener('click', () => {
                    const name = document.getElementById('siteName').value.trim();
                    const url = document.getElementById('siteUrl').value.trim();
                    const description = document.getElementById('siteDescription').value.trim();
                    const category = document.getElementById('siteCategory').value;
                    const imageUrl = document.getElementById('siteImageUrl').value.trim();
                    
                    if (!name || !url || !description || !category) {
                        common.showAlert('请填写所有必填字段', 'error');
                        return;
                    }
                    
                    // 创建新网站对象
                    const newSite = {
                        id: Date.now(), // 使用时间戳作为临时ID
                        name,
                        url,
                        description,
                        category: [category],
                        imageUrl: imageUrl || `https://via.placeholder.com/400x225?text=${encodeURIComponent(name)}`,
                        visits: 0,
                        rating: 0,
                        addedDate: new Date().toISOString().split('T')[0]
                    };
                    
                    // 添加到模拟数据中
                    mockSites.unshift(newSite);
                    
                    // 关闭模态框并重置表单
                    addSiteModal.hide();
                    document.getElementById('addSiteForm').reset();
                    
                    // 更新UI
                    renderDiscoverCards(mockSites);
                    renderTrendingList(mockSites);
                    
                    common.showAlert(`已成功添加网站: ${name}`);
                    common.log('添加了新网站', 'success', `名称: ${name}, 分类: ${category}`);
                });
            }
            
            // 初始化标签页切换
            function initTabs() {
                const tabButtons = document.querySelectorAll('#exploreTabs button');
                
                tabButtons.forEach(button => {
                    button.addEventListener('shown.bs.tab', () => {
                        if (button.id === 'favorites-tab') {
                            renderFavorites();
                        }
                    });
                });
            }
            
            // 初始化所有功能
            function init() {
                renderDiscoverCards(mockSites);
                renderTrendingList(mockSites);
                renderFavorites();
                initSearch();
                initCategoryFilter();
                initRandomDiscover();
                initLoadMore();
                initAddSiteForm();
                initTabs();
                
                // 尝试从 GitHub 加载最新数据
                loadFromGithub();
                
                // 显示欢迎消息
                common.showAlert('欢迎使用探索网页系统！发现有趣的网站，开拓您的网络视野。');
                common.log('探索网页系统已加载', 'info');
            }
            
            // 启动应用
            init();
        });
    </script>
    
    <!-- 工具箱模块JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 模拟浏览器收藏夹数据
            const mockBookmarks = {
                title: "根文件夹",
                children: [
                    {
                        title: "常用工具",
                        children: [
                            {title: "百度", url: "https://www.baidu.com", iconUrl: "../../img/图床/baidu.gif"},
                            {title: "Google", url: "https://www.google.com", iconUrl: "../../img/图床/google.gif"},
                            {title: "Bing", url: "https://www.bing.com", iconUrl: "../../img/图床/bing.webp"},
                            {title: "GitHub", url: "https://github.com", iconUrl: ""}
                        ]
                    },
                    {
                        title: "视频网站",
                        children: [
                            {title: "哔哩哔哩", url: "https://www.bilibili.com", iconUrl: "../../img/图床/bilibili.gif"},
                            {title: "YouTube", url: "https://www.youtube.com", iconUrl: ""}
                        ]
                    },
                    {
                        title: "开发资源",
                        children: [
                            {title: "MDN Web Docs", url: "https://developer.mozilla.org", iconUrl: ""},
                            {title: "Stack Overflow", url: "https://stackoverflow.com", iconUrl: ""},
                            {title: "Bootstrap", url: "https://getbootstrap.com", iconUrl: ""}
                        ]
                    }
                ]
            };
            
            // 渲染收藏夹函数
            function renderBookmarks(bookmarks, container) {
                container.innerHTML = '';
                
                if (bookmarks && bookmarks.children && bookmarks.children.length > 0) {
                    bookmarks.children.forEach(folder => {
                        // 创建文件夹元素
                        const folderElement = document.createElement('div');
                        folderElement.className = 'bookmark-folder';
                        
                        // 创建文件夹标题
                        const folderHeader = document.createElement('div');
                        folderHeader.className = 'bookmark-folder-header';
                        folderHeader.innerHTML = `
                            <i class="fas fa-chevron-right"></i>
                            <span>${folder.title}</span>
                            <span class="ml-2 badge bg-primary">${folder.children ? folder.children.length : 0}</span>
                        `;
                        
                        // 创建书签项目容器
                        const bookmarkItemsContainer = document.createElement('div');
                        bookmarkItemsContainer.className = 'bookmark-items';
                        
                        // 绑定折叠/展开事件
                        folderHeader.addEventListener('click', function() {
                            folderHeader.classList.toggle('collapsed');
                            if (bookmarkItemsContainer.style.display === 'none') {
                                bookmarkItemsContainer.style.display = 'grid';
                            } else {
                                bookmarkItemsContainer.style.display = 'none';
                            }
                        });
                        
                        // 添加书签项目
                        if (folder.children) {
                            folder.children.forEach(bookmark => {
                                const bookmarkItem = document.createElement('a');
                                bookmarkItem.className = 'bookmark-item';
                                bookmarkItem.href = bookmark.url;
                                bookmarkItem.target = '_blank';
                                
                                // 获取favicon或使用默认图标
                                let faviconHtml = '';
                                if (bookmark.iconUrl) {
                                    faviconHtml = `<img src="${bookmark.iconUrl}" alt="图标" class="bookmark-favicon">`;
                                } else {
                                    // 尝试使用favicon服务
                                    const domain = new URL(bookmark.url).hostname;
                                    faviconHtml = `<img src="https://www.google.com/s2/favicons?domain=${domain}" alt="图标" class="bookmark-favicon">`;
                                }
                                
                                bookmarkItem.innerHTML = `
                                    ${faviconHtml}
                                    <span class="bookmark-title">${bookmark.title}</span>
                                `;
                                
                                bookmarkItemsContainer.appendChild(bookmarkItem);
                            });
                        }
                        
                        // 组装文件夹元素
                        folderElement.appendChild(folderHeader);
                        folderElement.appendChild(bookmarkItemsContainer);
                        
                        container.appendChild(folderElement);
                    });
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning text-center py-4">
                            <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
                            <p>未找到收藏夹数据</p>
                        </div>
                    `;
                }
            }
            
            // 刷新按钮事件
            document.getElementById('refreshBookmarks').addEventListener('click', function() {
                const container = document.getElementById('bookmarksContainer');
                
                // 显示加载状态
                container.innerHTML = `
                    <div class="text-center py-6">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="text-muted">正在加载收藏夹...</p>
                    </div>
                `;
                
                // 模拟加载延迟
                setTimeout(() => {
                    renderBookmarks(mockBookmarks, container);
                }, 800);
            });
            
            // 页面加载时自动尝试加载收藏夹
            // 在实际环境中，由于浏览器安全限制，这里会显示提示信息
            // 用户需要点击刷新按钮来加载模拟数据
        });
    </script>
    
    <!-- 操作日志 offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="logOffcanvas" aria-labelledby="logOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="logOffcanvasLabel">操作日志</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted small">记录主要操作和错误信息</span>
                <button id="clearLogsBtn" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-trash me-1"></i>清空日志
                </button>
            </div>
            <div id="logContainer" class="mb-3">
                <div id="emptyLogMessage" class="text-center text-muted p-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>暂无操作记录</p>
                </div>
            </div>
            <div class="small text-muted">
                <i class="fas fa-info-circle me-1"></i>
                日志记录文件同步、编辑等操作
            </div>
        </div>
    </div>
    
    <!-- 深色模式功能 -->
    <script src="../../js/dark-mode.js"></script>
</body>
</html>