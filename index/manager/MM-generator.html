<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MM-generator</title>
    <!-- PWA相关配置 -->
    <link rel="manifest" href="../../manifest.json">
    <meta name="theme-color" content="#3e8e41">
    <meta name="description" content="密码生成和管理工具">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="密码生成器">
    <link rel="apple-touch-icon" href="../../img/index.png">
    
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/all.min.css">
    <link href="../../css/manager-styles.css" rel="stylesheet">
    <!-- 引入通用脚本 -->
    <script src="../../js/manager-common.js"></script>
    <style>
        /* 页面特定样式 */
        .header-gradient {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }
        
        .option-card {
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
        }
        
        .option-card:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .entry-item {
            border-left: 4px solid #3498db;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .entry-item:active {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .entry-item.dragging {
            opacity: 0.6;
            background: #e3f2fd;
        }
        
        .entry-item.editing {
            background: #e3f2fd;
            border-left-color: #2ecc71;
        }
        
        .drag-handle {
            cursor: move;
            color: #7f8c8d;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            transition: all 0.2s ease;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background-color: #e9ecef;
        }
        
        .baidu-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .baidu-button {
            display: block;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #2932e1;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @media (max-width: 768px) {
            .home-button {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
        
        /* 管理页面导航栏中的感叹号按钮样式 */
        .manager-nav-button.bg-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%) !important;
            color: white !important;
        }
        
        .manager-nav-button.bg-warning:hover {
            background: linear-gradient(135deg, #ffb300 0%, #ffa000 100%) !important;
            color: white !important;
        }
        
        /* 日志条目样式 */
        .log-entry {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            font-size: 0.875rem;
        }
        
        .log-entry.success {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        
        .log-entry.error {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        
        .log-entry.warning {
            border-left-color: #ffc107;
            background-color: #fffef0;
        }
        
        .log-entry.info {
            border-left-color: #17a2b8;
            background-color: #f0f9ff;
        }
        
        .log-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .log-message {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .log-details {
            font-size: 0.8rem;
            color: #6c757d;
            white-space: pre-wrap;
        }
        
        /* 密码输入样式 */
        .password-input {
            width: 50px;
            height: 50px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .password-input.filled {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        /* 图案按钮样式 */
        .pattern-btn {
            width: 60px;
            height: 60px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pattern-btn:hover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .pattern-btn:active {
            transform: scale(0.95);
        }
        
        /* 图案按钮内的SVG样式 */
        .pattern-btn svg {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body class="manager-body d-flex flex-column min-vh-100 p-3">
    <!-- 返回首页按钮 -->
    <a href="../../index.html" class="home-button bg-dark text-white" title="返回首页">
        <i class="fas fa-home"></i>
    </a>
    
    <!-- 管理页面导航栏 -->
    <div class="manager-nav">
        <a href="nav-manager.html" class="manager-nav-button" title="导航数据管理">
            <i class="fas fa-sitemap"></i>
        </a>
        <a href="MM-generator.html" class="manager-nav-button active" title="密码生成器">
            <i class="fas fa-key"></i>
        </a>
        <a href="vol-manager.html" class="manager-nav-button" title="版本管理">
            <i class="fas fa-code-branch"></i>
        </a>
        <a href="explore-manager.html" class="manager-nav-button" title="探索网页">
            <i class="fas fa-compass"></i>
        </a>
        <!-- 操作日志按钮 -->
        <button class="manager-nav-button bg-warning text-white" title="操作日志" data-bs-toggle="offcanvas" data-bs-target="#logOffcanvas">
            <i class="fas fa-exclamation-circle"></i>
        </button>
    </div>
    
    <div class="container flex-grow-1 d-flex flex-column">
        <header class="manager-header text-center text-white p-4 rounded mb-4">
            <h1 class="mb-2">MM-generator</h1>
            <p class="lead mb-0">上传、编辑并下载HTML文件</p>
        </header>
        
        <!-- 解密模态框 -->
        <div class="modal fade" id="decryptModal" tabindex="-1" aria-labelledby="decryptModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="decryptModalLabel">文件解密</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="decryptPassword" class="form-label">请输入四位数图案密码：</label>
                            <div class="password-input-container d-flex justify-content-center align-items-center gap-3 mb-4">
                                <div class="password-input" id="decryptPassword1"></div>
                                <div class="password-input" id="decryptPassword2"></div>
                                <div class="password-input" id="decryptPassword3"></div>
                                <div class="password-input" id="decryptPassword4"></div>
                            </div>
                            <div class="pattern-buttons d-flex justify-content-center gap-3">
                                <button class="pattern-btn" id="patternA">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><rect x="10" y="10" width="20" height="20" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                                <button class="pattern-btn" id="patternB">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,10 30,30 10,30" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                                <button class="pattern-btn" id="patternC">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,10 30,20 20,30 10,20" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                                <button class="pattern-btn" id="patternD">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,10 25,18 33,20 27,26 28,34 20,30 12,34 13,26 7,20 15,18" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                            </div>
                            <div class="text-center mt-4">
                                <button class="btn btn-secondary" id="clearDecryptPassword">清空</button>
                            </div>
                            <div class="text-danger mt-3 text-center" id="decryptError"></div>
                            <div class="text-warning mt-3 text-center" id="decryptWarning"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmDecrypt">确认解密</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 加密模态框 -->
        <div class="modal fade" id="encryptModal" tabindex="-1" aria-labelledby="encryptModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="encryptModalLabel">文件加密</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="encryptPassword" class="form-label">请输入四位数图案密码：</label>
                            <div class="password-input-container d-flex justify-content-center align-items-center gap-3 mb-4">
                                <div class="password-input" id="encryptPassword1"></div>
                                <div class="password-input" id="encryptPassword2"></div>
                                <div class="password-input" id="encryptPassword3"></div>
                                <div class="password-input" id="encryptPassword4"></div>
                            </div>
                            <div class="pattern-buttons d-flex justify-content-center gap-3">
                                <button class="pattern-btn" id="encryptPatternA">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><rect x="10" y="10" width="20" height="20" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                                <button class="pattern-btn" id="encryptPatternB">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,10 30,30 10,30" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                                <button class="pattern-btn" id="encryptPatternC">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,10 30,20 20,30 10,20" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                                <button class="pattern-btn" id="encryptPatternD">
                                    <svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,10 25,18 33,20 27,26 28,34 20,30 12,34 13,26 7,20 15,18" fill="none" stroke="#000" stroke-width="2"/></svg>
                                </button>
                            </div>
                            <div class="text-center mt-4">
                                <button class="btn btn-secondary" id="clearEncryptPassword">清空</button>
                            </div>
                            <div class="text-danger mt-3 text-center" id="encryptError"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmEncrypt">确认加密</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="upload-section bg-white rounded shadow p-4 mb-4 text-center" id="uploadSection">
            <h2 class="mb-4">请选择加载方式</h2>
            
            <div class="row justify-content-center g-4">
                <div class="col-md-6">
                    <div class="option-card p-4 rounded bg-light h-100">
                        <div class="option-title h5 mb-3 text-dark">从本地上传</div>
                        <input type="file" id="fileInput" class="d-none" accept=".json">
                        <button id="uploadBtn" class="btn manager-btn-primary w-100 py-3">
                            <i class="fas fa-upload me-2"></i>
                            选择文件并上传
                        </button>
                        <div id="fileInfo" class="mt-3 p-2 bg-light rounded small"></div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="option-card p-4 rounded bg-light h-100">
                        <div class="option-title h5 mb-3 text-dark">从网络加载</div>
                        <button id="loadUrlBtn" class="btn manager-btn-warning w-100 py-3">
                            <i class="fas fa-link me-2"></i>
                            加载文件
                        </button>
                        <div id="urlError" class="text-danger mt-2 small"></div>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="mt-4 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">正在加载...</span>
                </div>
                <p class="mt-2">正在加载文件...</p>
            </div>
        </div>
        
        <div class="main-content d-none flex-column" id="mainContent">
            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <div class="bg-white rounded shadow p-4 h-100">
                        <h2 class="section-title border-bottom pb-2 mb-3">添加新条目</h2>
                        <p class="text-muted mb-3">在此处添加新的密码模式条目，添加后将在右侧列表中显示</p>
                        
                        <form id="entryForm" class="mb-4">
                            <div class="mb-3">
                                <label for="platform" class="form-label">平台</label>
                                <input type="text" class="form-control" id="platform" placeholder="例如: 工作邮箱、GitHub、QQ" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="accountType" class="form-label">账号:</label>
                                <input type="text" class="form-control" id="accountType" placeholder="例如: 邮箱、微信、经典" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="passwordPattern" class="form-label">MM:</label>
                                <input type="text" class="form-control" id="passwordPattern" placeholder="例如: 大经典、错位小@数字">
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    <button class="quick-insert-btn btn btn-sm btn-outline-primary" data-value="大经典">大经典</button>
                                    <button class="quick-insert-btn btn btn-sm btn-outline-primary" data-value="小经典">小经典</button>
                                    <button class="quick-insert-btn btn btn-sm btn-outline-primary" data-value="错位小">错位小</button>
                                    <button class="quick-insert-btn btn btn-sm btn-outline-primary" data-value="@">@</button>
                                    <button class="quick-insert-btn btn btn-sm btn-outline-primary" data-value="数字">数字</button>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn manager-btn-primary w-100">添加条目</button>
                        </form>
                        
                        <div id="editForm" class="d-none bg-light p-3 rounded border-start border-primary">
                            <h3 class="mb-3">编辑条目</h3>
                            <div class="mb-3">
                                <label for="editPlatform" class="form-label">平台</label>
                                <input type="text" class="form-control" id="editPlatform" placeholder="例如: 工作邮箱、GitHub、QQ" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editAccountType" class="form-label">账号:</label>
                                <input type="text" class="form-control" id="editAccountType" placeholder="例如: 邮箱、微信、经典" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editPasswordPattern" class="form-label">MM:</label>
                                <input type="text" class="form-control" id="editPasswordPattern" placeholder="例如: 大经典、错位小@数字">
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    <button class="quick-insert-btn-edit btn btn-sm btn-outline-primary" data-value="大经典">大经典</button>
                                    <button class="quick-insert-btn-edit btn btn-sm btn-outline-primary" data-value="小经典">小经典</button>
                                    <button class="quick-insert-btn-edit btn btn-sm btn-outline-primary" data-value="错位小">错位小</button>
                                    <button class="quick-insert-btn-edit btn btn-sm btn-outline-primary" data-value="@">@</button>
                                    <button class="quick-insert-btn-edit btn btn-sm btn-outline-primary" data-value="数字">数字</button>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex">
                                <button id="saveEditBtn" class="btn manager-btn-success flex-fill">保存修改</button>
                                <button id="cancelEditBtn" class="btn manager-btn-warning flex-fill">取消</button>
                            </div>
                        </div>
                        
                        <div class="bg-info bg-opacity-10 p-3 rounded mt-4">
                            <strong>使用说明：</strong><br>
                            1. 填写平台、账号类型和密码模式<br>
                            2. 点击"添加条目"按钮添加到右侧列表<br>
                            3. 在右侧可以拖拽排序或删除条目<br>
                            4. <strong>双击条目可在左侧编辑</strong>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="bg-white rounded shadow p-4 h-100 d-flex flex-column">
                        <h2 class="section-title border-bottom pb-2 mb-3">已添加条目 <small class="text-muted">(拖拽排序)</small></h2>
                        <p class="text-muted mb-3">所有已添加的条目列表，支持拖拽排序和删除操作</p>
                        
                        <div class="entries-container flex-grow-1 d-flex flex-column">
                            <div id="entriesList" class="entries-list flex-grow-1 overflow-auto mb-3">
                                <!-- 条目将在这里动态添加 -->
                            </div>
                            <div id="listStats" class="bg-light p-2 rounded text-center"></div>
                        </div>
                        
                        <!-- 生成的HTML文件不再包含跳转按钮 -->
                    </div>
                </div>
            </div>
            
            <div class="download-section text-center">
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button id="downloadBtn" class="btn manager-btn-success btn-lg px-4">下载JSON文件</button>
                    <button id="resetBtn" class="btn btn-secondary btn-lg px-4">重置</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../js/bootstrap.bundle.min.js"></script>
    <script>
        // AES加密解密功能
        class AESUtil {
            // AES-256-CBC加密
            static encrypt(text, password) {
                const encoder = new TextEncoder();
                const textData = encoder.encode(text);
                const passwordData = encoder.encode(password.padEnd(32, ' '));
                
                const iv = crypto.getRandomValues(new Uint8Array(16));
                const salt = crypto.getRandomValues(new Uint8Array(16));
                
                return window.crypto.subtle.importKey(
                    'raw',
                    passwordData,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                ).then(key => {
                    return window.crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: salt,
                            iterations: 100000,
                            hash: 'SHA-256'
                        },
                        key,
                        {
                            name: 'AES-CBC',
                            length: 256
                        },
                        false,
                        ['encrypt']
                    );
                }).then(key => {
                    return window.crypto.subtle.encrypt(
                        {
                            name: 'AES-CBC',
                            iv: iv
                        },
                        key,
                        textData
                    );
                }).then(encrypted => {
                    const encryptedData = new Uint8Array(encrypted);
                    const totalLength = salt.length + iv.length + encryptedData.length;
                    const combined = new Uint8Array(totalLength);
                    
                    combined.set(salt, 0);
                    combined.set(iv, salt.length);
                    combined.set(encryptedData, salt.length + iv.length);
                    
                    return btoa(String.fromCharCode.apply(null, combined));
                });
            }
            
            // AES-256-CBC解密
            static decrypt(encryptedData, password) {
                const combined = new Uint8Array(atob(encryptedData).split('').map(char => char.charCodeAt(0)));
                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 32);
                const encrypted = combined.slice(32);
                
                const encoder = new TextEncoder();
                const passwordData = encoder.encode(password.padEnd(32, ' '));
                
                return window.crypto.subtle.importKey(
                    'raw',
                    passwordData,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveKey']
                ).then(key => {
                    return window.crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: salt,
                            iterations: 100000,
                            hash: 'SHA-256'
                        },
                        key,
                        {
                            name: 'AES-CBC',
                            length: 256
                        },
                        false,
                        ['decrypt']
                    );
                }).then(key => {
                    return window.crypto.subtle.decrypt(
                        {
                            name: 'AES-CBC',
                            iv: iv
                        },
                        key,
                        encrypted
                    );
                }).then(decrypted => {
                    const decoder = new TextDecoder();
                    return decoder.decode(decrypted);
                });
            }
        }
        
        // Cookie管理工具
        class CookieUtil {
            static set(name, value, days) {
                let expires = '';
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = '; expires=' + date.toUTCString();
                }
                document.cookie = name + '=' + (value || '')  + expires + '; path=/';
            }
            
            static get(name) {
                const nameEQ = name + '=';
                const ca = document.cookie.split(';');
                for(let i=0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0)==' ') c = c.substring(1,c.length);
                    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
                }
                return null;
            }
        }
        
        // 图案密码工具
        class PatternPassword {
            constructor(modalType) {
                this.modalType = modalType; // 'encrypt' 或 'decrypt'
                this.password = [];
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.reset();
            }
            
            bindEvents() {
                // 图案按钮点击事件
                const patternButtons = document.querySelectorAll('.pattern-btn');
                patternButtons.forEach((btn, index) => {
                    btn.addEventListener('click', () => {
                        this.addPattern(String.fromCharCode(65 + index)); // A, B, C, D
                    });
                });
                
                // 清空按钮点击事件
                document.getElementById(`clear${this.modalType.charAt(0).toUpperCase() + this.modalType.slice(1)}Password`).addEventListener('click', () => {
                    this.reset();
                });
            }
            
            addPattern(pattern) {
                if (this.password.length < 4) {
                    this.password.push(pattern);
                    this.updateUI();
                    
                    // 密码输入完成
                    if (this.password.length === 4) {
                        // 解密时需要检查密码
                        if (this.modalType === 'decrypt') {
                            // 检查是否达到最大尝试次数
                            const errorCount = parseInt(CookieUtil.get('mmks') || 0);
                            if (errorCount >= 3) {
                                document.getElementById('decryptError').textContent = '密码错误次数过多，请24小时后再试！';
                                return;
                            }
                        }
                    }
                }
            }
            
            updateUI() {
                for (let i = 1; i <= 4; i++) {
                    const inputElement = document.getElementById(`${this.modalType}Password${i}`);
                    if (i <= this.password.length) {
                        inputElement.textContent = this.password[i - 1];
                        inputElement.classList.add('filled');
                    } else {
                        inputElement.textContent = '';
                        inputElement.classList.remove('filled');
                    }
                }
            }
            
            getPassword() {
                return this.password.join('');
            }
            
            reset() {
                this.password = [];
                this.updateUI();
                document.getElementById(`${this.modalType}Error`).textContent = '';
            }
            
            // 根据日期打乱图案顺序（仅解密时使用）
            static shufflePatterns() {
                if (this.modalType !== 'decrypt') return;
                
                const patterns = ['A', 'B', 'C', 'D'];
                const today = new Date();
                const dayOfMonth = today.getDate();
                
                // 根据日期生成伪随机数
                const seed = dayOfMonth;
                for (let i = patterns.length - 1; i > 0; i--) {
                    const j = (seed + i) % (i + 1);
                    [patterns[i], patterns[j]] = [patterns[j], patterns[i]];
                }
                
                // 更新按钮顺序
                const patternButtons = document.querySelectorAll('.pattern-btn');
                const parent = patternButtons[0].parentElement;
                
                // 移除所有按钮
                patternButtons.forEach(btn => parent.removeChild(btn));
                
                // 重新添加按钮（打乱顺序）
                patterns.forEach(pattern => {
                    const btn = document.getElementById(`pattern${pattern}`);
                    parent.appendChild(btn);
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始初始化');
            
            // 获取DOM元素
            const uploadSection = document.getElementById('uploadSection');
            const mainContent = document.getElementById('mainContent');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInfo = document.getElementById('fileInfo');
            const loadUrlBtn = document.getElementById('loadUrlBtn');
            const urlError = document.getElementById('urlError');
            const loading = document.getElementById('loading');
            const entryForm = document.getElementById('entryForm');
            const editForm = document.getElementById('editForm');
            const entriesList = document.getElementById('entriesList');
            const downloadBtn = document.getElementById('downloadBtn');
            const resetBtn = document.getElementById('resetBtn');
            const listStats = document.getElementById('listStats');
            const saveEditBtn = document.getElementById('saveEditBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            const logContainer = document.getElementById('logContainer');
            const emptyLogMessage = document.getElementById('emptyLogMessage');
            const decryptModal = new bootstrap.Modal(document.getElementById('decryptModal'));
            const encryptModal = new bootstrap.Modal(document.getElementById('encryptModal'));
            
            // 全局变量
            let entries = [];
            let draggedItem = null;
            let currentFileName = '';
            let editingIndex = -1;
            let currentFileContent = '';
            let isEncryptedFile = false;
            let currentFileArrayBuffer = null; // 保存网络加载的原始ArrayBuffer
            
            // 固定的URL地址
            const FIXED_URL = '/js/MM.json';
            
            // 图案密码实例
            let decryptPatternPassword = new PatternPassword('decrypt');
            let encryptPatternPassword = new PatternPassword('encrypt');
            
            // 快捷输入按钮事件处理
            document.querySelectorAll('.quick-insert-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const input = document.getElementById('passwordPattern');
                    input.value = input.value + value;
                    input.focus();
                });
            });
            
            document.querySelectorAll('.quick-insert-btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const input = document.getElementById('editPasswordPattern');
                    input.value = input.value + value;
                    input.focus();
                });
            });
            
            // 操作日志系统
            const operationLogs = [];
            const LOG_TYPES = {
                SUCCESS: 'success',
                ERROR: 'error',
                WARNING: 'warning',
                INFO: 'info'
            };
            
            // 添加日志条目
            function addLogEntry(type, message, details = '') {
                const logEntry = {
                    timestamp: new Date().toLocaleString('zh-CN'),
                    type: type,
                    message: message,
                    details: details
                };
                
                operationLogs.unshift(logEntry); // 最新的日志在最前面
                
                // 限制日志数量
                if (operationLogs.length > 100) {
                    operationLogs.pop();
                }
                
                renderLogs();
            }
            
            // 渲染日志
            function renderLogs() {
                if (operationLogs.length === 0) {
                    emptyLogMessage.style.display = 'block';
                    logContainer.innerHTML = '';
                    return;
                }
                
                emptyLogMessage.style.display = 'none';
                logContainer.innerHTML = '';
                
                operationLogs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = `log-entry ${log.type}`;
                    logElement.innerHTML = `
                        <div class="log-time">${log.timestamp}</div>
                        <div class="log-message">${log.message}</div>
                        ${log.details ? `<div class="log-details">${log.details}</div>` : ''}
                    `;
                    logContainer.appendChild(logElement);
                });
            }
            
            // 清空所有日志
            function clearAllLogs() {
                operationLogs.length = 0;
                renderLogs();
                addLogEntry(LOG_TYPES.INFO, '操作日志已清空');
            }
            
            // 绑定日志清除按钮事件
            clearLogsBtn.addEventListener('click', clearAllLogs);
            
            // 页面加载时添加初始日志
            addLogEntry(LOG_TYPES.INFO, '密码生成器系统启动');
            
            // 上传按钮点击事件
            uploadBtn.addEventListener('click', function() {
                console.log('上传按钮被点击');
                fileInput.click();
                addLogEntry(LOG_TYPES.INFO, '点击了文件上传按钮');
            });
            
            // 文件选择事件
            fileInput.addEventListener('change', function(e) {
                console.log('文件选择变化');
                const file = e.target.files[0];
                if (file) {
                    console.log('文件已选择:', file.name);
                    currentFileName = file.name;
                    fileInfo.textContent = `已选择文件: ${file.name} (${formatFileSize(file.size)})`;
                    
                    // 记录开始加载
                    addLogEntry(LOG_TYPES.INFO, '开始加载文件', `文件名: ${file.name}, 文件大小: ${formatFileSize(file.size)}, 来源: 本地上传`);
                    
                    const reader = new FileReader();
                    
                    // 先以ArrayBuffer形式读取文件，用于检测文件类型
                    reader.onload = function(e) {
                        try {
                            console.log('文件读取成功');
                            const arrayBuffer = e.target.result;
                            const content = new TextDecoder().decode(arrayBuffer);
                            currentFileContent = content;
                            
                            // 检查是否是加密文件
                            // 1. 检查是否以'data:'开头（完整的data URL）
                            // 2. 检查是否看起来是base64编码的内容
                            // 3. 检查是否包含不可打印字符或乱码（可能是二进制加密文件）
                            function isBase64(str) {
                                try {
                                    // 检查是否只包含base64字符
                                    return /^[A-Za-z0-9+/]*={0,2}$/.test(str) && 
                                           // 检查长度是否是4的倍数
                                           (str.length % 4 === 0);
                                } catch {
                                    return false;
                                }
                            }
                            
                            function containsBinaryData(str) {
                                // 检查是否包含不可打印字符（除了换行符、制表符等常见控制字符）
                                // 或者包含Unicode替换字符（表示解码错误）
                                return /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F\ufffd]/.test(str);
                            }
                            
                            if (content.startsWith('data:') || isBase64(content) || containsBinaryData(content)) {
                                isEncryptedFile = true;
                                showDecryptModal();
                            } else {
                                isEncryptedFile = false;
                                parseFileContent(content);
                                
                                // 切换到主内容界面
                                uploadSection.classList.add('d-none');
                                mainContent.classList.remove('d-none');
                                mainContent.classList.add('d-flex');
                                addLogEntry(LOG_TYPES.SUCCESS, `文件上传成功`, `文件名: ${file.name}, 解析出 ${entries.length} 个条目, 来源: 本地上传`);
                            }
                        } catch (error) {
                            console.error('文件解析失败:', error);
                            alert('文件解析失败: ' + error.message);
                            fileInfo.textContent = '文件解析失败，请选择有效的文件';
                            addLogEntry(LOG_TYPES.ERROR, `文件解析失败`, `文件名: ${file.name}, 错误信息: ${error.message}, 来源: 本地上传`);
                        }
                    };
                    reader.onerror = function() {
                        console.error('文件读取错误');
                        fileInfo.textContent = '文件读取错误，请重试';
                        addLogEntry(LOG_TYPES.ERROR, '文件读取失败', `文件名: ${file.name}, 无法读取选定的文件, 来源: 本地上传`);
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    console.log('未选择文件');
                }
            });
            
            // 从固定URL加载文件
            loadUrlBtn.addEventListener('click', function() {
                console.log('加载URL按钮被点击');
                // 显示加载中
                loading.classList.remove('d-none');
                urlError.textContent = '';
                currentFileName = 'MM.json';
                
                // 记录开始加载
                addLogEntry(LOG_TYPES.INFO, '开始从网络加载文件', `URL: ${FIXED_URL}, 文件名: ${currentFileName}, 来源: 网络加载`);
                
                console.log('开始从URL加载文件:', FIXED_URL);
                fetch(FIXED_URL)
                    .then(response => {
                        console.log('收到响应:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP错误! 状态: ${response.status}`);
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        console.log('文件加载成功，开始解析');
                        const content = new TextDecoder().decode(arrayBuffer);
                        currentFileContent = content;
                        currentFileArrayBuffer = arrayBuffer; // 保存原始ArrayBuffer
                        
                        // 检查是否是加密文件
                        // 1. 检查是否以'data:'开头（完整的data URL）
                        // 2. 检查是否看起来是base64编码的内容
                        // 3. 检查是否包含不可打印字符或乱码（可能是二进制加密文件）
                        function isBase64(str) {
                            try {
                                // 检查是否只包含base64字符
                                return /^[A-Za-z0-9+/]*={0,2}$/.test(str) && 
                                       // 检查长度是否是4的倍数
                                       (str.length % 4 === 0);
                            } catch {
                                return false;
                            }
                        }
                        
                        function containsBinaryData(str) {
                            // 检查是否包含不可打印字符（除了换行符、制表符等常见控制字符）
                            // 或者包含Unicode替换字符（表示解码错误）
                            return /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F\ufffd]/.test(str);
                        }
                        
                        if (content.startsWith('data:') || isBase64(content) || containsBinaryData(content)) {
                            isEncryptedFile = true;
                            showDecryptModal();
                        } else {
                            isEncryptedFile = false;
                            parseFileContent(content);
                            
                            // 切换到主内容界面
                            uploadSection.classList.add('d-none');
                            mainContent.classList.remove('d-none');
                            mainContent.classList.add('d-flex');
                            
                            // 记录成功加载
                            addLogEntry(LOG_TYPES.SUCCESS, '网络文件加载成功', `URL: ${FIXED_URL}, 文件名: ${currentFileName}, 解析出 ${entries.length} 个条目, 来源: 网络加载`);
                        }
                    })
                    .catch(error => {
                        console.error('URL加载错误:', error);
                        urlError.textContent = `加载失败: ${error.message}`;
                        
                        // 记录加载失败
                        addLogEntry(LOG_TYPES.ERROR, '网络文件加载失败', `URL: ${FIXED_URL}, 文件名: ${currentFileName}, 错误信息: ${error.message}, 来源: 网络加载`);
                    })
                    .finally(() => {
                        console.log('加载完成');
                        loading.classList.add('d-none');
                    });
            });
            
            // 格式化文件大小
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            // 解析文件内容
            function parseFileContent(content) {
                console.log('开始解析文件内容');
                // 清空现有条目
                entries = [];
                
                try {
                    // 解析为JSON
                    entries = JSON.parse(content);
                    console.log(`JSON解析完成，找到 ${entries.length} 个条目`);
                } catch (jsonError) {
                    console.error('JSON解析失败:', jsonError);
                    alert('JSON文件解析失败: ' + jsonError.message);
                    addLogEntry(LOG_TYPES.ERROR, 'JSON文件解析失败', `错误信息: ${jsonError.message}`);
                    return;
                }
                
                // 渲染条目列表
                renderEntriesList();
            }
            
            // 添加新条目
            entryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const platform = document.getElementById('platform').value;
                const accountType = document.getElementById('accountType').value;
                const passwordPattern = document.getElementById('passwordPattern').value;
                
                if (platform && accountType) {
                    addEntry({ platform, accountType, passwordPattern });
                    
                    // 清空表单
                    entryForm.reset();
                }
            });
            
            // 保存编辑
            saveEditBtn.addEventListener('click', function() {
                if (editingIndex >= 0) {
                    const platform = document.getElementById('editPlatform').value;
                    const accountType = document.getElementById('editAccountType').value;
                    const passwordPattern = document.getElementById('editPasswordPattern').value;
                    
                    if (platform && accountType) {
                        const oldEntry = entries[editingIndex];
                        entries[editingIndex] = { platform, accountType, passwordPattern };
                        renderEntriesList();
                        cancelEdit();
                        addLogEntry(LOG_TYPES.SUCCESS, '保存了条目编辑', `平台: ${oldEntry.platform} → ${platform}, 账号: ${oldEntry.accountType} → ${accountType}`);
                    }
                }
            });
            
            // 取消编辑
            cancelEditBtn.addEventListener('click', cancelEdit);
            
            function cancelEdit() {
                editForm.classList.add('d-none');
                entryForm.classList.remove('d-none');
                editingIndex = -1;
                
                // 移除所有条目的编辑状态
                document.querySelectorAll('.entry-item.editing').forEach(item => {
                    item.classList.remove('editing');
                });
            }
            
            // 显示解密模态框
            function showDecryptModal() {
                // 根据日期打乱解密时的图案顺序
                PatternPassword.shufflePatterns();
                decryptModal.show();
            }
            
            // 确认解密按钮点击事件
            document.getElementById('confirmDecrypt').addEventListener('click', async function() {
                const password = decryptPatternPassword.getPassword();
                if (password.length !== 4) {
                    document.getElementById('decryptError').textContent = '请输入完整的四位数密码';
                    return;
                }
                
                try {
                    const errorCount = parseInt(CookieUtil.get('mmks') || 0);
                    if (errorCount >= 3) {
                        document.getElementById('decryptError').textContent = '密码错误次数过多，请24小时后再试！';
                        return;
                    }
                    
                    // 解密文件内容
                    let encryptedData = currentFileContent;
                    // 如果是完整的data URL，去掉前缀
                    if (encryptedData.startsWith('data:application/json;base64,')) {
                        encryptedData = encryptedData.replace('data:application/json;base64,', '');
                    }
                    
                    // 如果内容包含不可打印字符，可能是二进制数据，尝试转换为base64
                    function containsBinaryData(str) {
                        return /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F\ufffd]/.test(str);
                    }
                    
                    if (containsBinaryData(encryptedData)) {
                        // 对于二进制数据，我们需要重新以ArrayBuffer读取原始文件
                        // 因为currentFileContent是通过TextDecoder解码的，可能已经损坏
                        console.log('检测到二进制数据，需要重新读取文件');
                        
                        if (fileInput.files && fileInput.files[0]) {
                            // 如果是通过文件上传的
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    const arrayBuffer = e.target.result;
                                    const binaryStr = String.fromCharCode.apply(null, new Uint8Array(arrayBuffer));
                                    const base64Data = btoa(binaryStr);
                                    
                                    // 重新解密
                                    AESUtil.decrypt(base64Data, password)
                                        .then(decryptedContent => {
                                            // 解析解密后的内容
                                            parseFileContent(decryptedContent);
                                            
                                            // 切换到主内容界面
                                            uploadSection.classList.add('d-none');
                                            mainContent.classList.remove('d-none');
                                            mainContent.classList.add('d-flex');
                                            
                                            // 关闭模态框
                                            decryptModal.hide();
                                            decryptPatternPassword.reset();
                                            
                                            // 清除错误计数
                                            CookieUtil.set('mmks', '0', 1);
                                            
                                            addLogEntry(LOG_TYPES.SUCCESS, '文件解密成功', `文件名: ${currentFileName}, 解析出 ${entries.length} 个条目`);
                                        })
                                        .catch(error => {
                                            handleDecryptError(error);
                                        });
                                } catch (error) {
                                    handleDecryptError(error);
                                }
                            };
                            reader.readAsArrayBuffer(fileInput.files[0]);
                            return;
                        } else {
                        // 如果是通过网络加载的，使用保存的原始ArrayBuffer
                        console.log('使用网络加载的原始ArrayBuffer进行处理');
                        try {
                            const binaryStr = String.fromCharCode.apply(null, new Uint8Array(currentFileArrayBuffer));
                            const base64Data = btoa(binaryStr);
                            
                            // 重新解密
                            AESUtil.decrypt(base64Data, password)
                                .then(decryptedContent => {
                                    // 解析解密后的内容
                                    parseFileContent(decryptedContent);
                                    
                                    // 切换到主内容界面
                                    uploadSection.classList.add('d-none');
                                    mainContent.classList.remove('d-none');
                                    mainContent.classList.add('d-flex');
                                    
                                    // 关闭模态框
                                    decryptModal.hide();
                                    decryptPatternPassword.reset();
                                    
                                    // 清除错误计数
                                    CookieUtil.set('mmks', '0', 1);
                                    
                                    addLogEntry(LOG_TYPES.SUCCESS, '文件解密成功', `文件名: ${currentFileName}, 解析出 ${entries.length} 个条目`);
                                })
                                .catch(error => {
                                    handleDecryptError(error);
                                });
                        } catch (error) {
                            handleDecryptError(error);
                        }
                        return;
                    }
                    }
                    
                    // 正常解密
                    const decryptedContent = await AESUtil.decrypt(encryptedData, password);
                    
                    function handleDecryptError(error) {
                        console.error('解密失败:', error);
                        
                        // 增加错误计数
                        const errorCount = parseInt(CookieUtil.get('mmks') || 0) + 1;
                        CookieUtil.set('mmks', errorCount.toString(), 1);
                        
                        document.getElementById('decryptError').textContent = '密码错误，请重试！';
                        decryptPatternPassword.reset();
                        
                        // 获取所有密码输入框并添加错误样式
                            const passwordInputs = document.querySelectorAll('.password-input');
                            passwordInputs.forEach(input => {
                                // 先移除可能存在的样式，确保动画能再次触发
                                input.classList.remove('input-error', 'shake');
                                // 触发重排，确保动画能正常播放
                                void input.offsetWidth;
                                // 添加错误样式
                                input.classList.add('input-error', 'shake');
                                
                                // 3秒后移除样式，以便下次错误时可以再次触发动画
                                setTimeout(() => {
                                    input.classList.remove('input-error', 'shake');
                                }, 3000);
                            });
                        
                        addLogEntry(LOG_TYPES.ERROR, '文件解密失败', `文件名: ${currentFileName}, 错误信息: ${error.message}`);
                        
                        // 显示错误提示
                        if (errorCount >= 3) {
                            document.getElementById('decryptError').textContent = '密码错误次数过多，请24小时后再试！';
                        }
                    }
                    
                    // 解析解密后的内容
                    parseFileContent(decryptedContent);
                    
                    // 切换到主内容界面
                    uploadSection.classList.add('d-none');
                    mainContent.classList.remove('d-none');
                    mainContent.classList.add('d-flex');
                    
                    // 关闭模态框
                    decryptModal.hide();
                    decryptPatternPassword.reset();
                    
                    // 清除错误计数
                    CookieUtil.set('mmks', '0', 1);
                    
                    addLogEntry(LOG_TYPES.SUCCESS, '文件解密成功', `文件名: ${currentFileName}, 解析出 ${entries.length} 个条目`);
                } catch (error) {
                    console.error('解密失败:', error);
                    
                    // 增加错误计数
                    const errorCount = parseInt(CookieUtil.get('mmks') || 0) + 1;
                    CookieUtil.set('mmks', errorCount.toString(), 1);
                    
                    document.getElementById('decryptError').textContent = '密码错误，请重试！';
                    decryptPatternPassword.reset();
                    
                    addLogEntry(LOG_TYPES.ERROR, '文件解密失败', `文件名: ${currentFileName}, 错误信息: ${error.message}`);
                    
                    // 显示错误提示
                    if (errorCount >= 3) {
                        document.getElementById('decryptError').textContent = '密码错误次数过多，请24小时后再试！';
                    }
                }
            });
            
            // 确认加密按钮点击事件
            document.getElementById('confirmEncrypt').addEventListener('click', async function() {
                const password = encryptPatternPassword.getPassword();
                if (password.length !== 4) {
                    document.getElementById('encryptError').textContent = '请输入完整的四位数密码';
                    return;
                }
                
                try {
                    // 生成下载内容
                    const content = generateDownloadContent();
                    
                    // 加密内容
                    const encryptedContent = await AESUtil.encrypt(content, password);
                    
                    // 下载加密文件
                    const dataUrl = 'data:application/json;base64,' + encryptedContent;
                    const blob = await (await fetch(dataUrl)).blob();
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = currentFileName;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    // 关闭模态框
                    encryptModal.hide();
                    encryptPatternPassword.reset();
                    
                    addLogEntry(LOG_TYPES.SUCCESS, '文件加密成功', `文件名: ${currentFileName}`);
                } catch (error) {
                    console.error('加密失败:', error);
                    document.getElementById('encryptError').textContent = '加密失败，请重试！';
                    addLogEntry(LOG_TYPES.ERROR, '文件加密失败', `文件名: ${currentFileName}, 错误信息: ${error.message}`);
                }
            });
            
            // 下载文件
            downloadBtn.addEventListener('click', function() {
                encryptModal.show();
                addLogEntry(LOG_TYPES.INFO, '点击了下载按钮');
            });
            
            // 重置
            resetBtn.addEventListener('click', function() {
                // 清空所有数据
                entries = [];
                fileInput.value = '';
                fileInfo.textContent = '';
                urlError.textContent = '';
                cancelEdit();
                
                // 切换回上传界面
                mainContent.classList.add('d-none');
                uploadSection.classList.remove('d-none');
                
                // 更新统计信息
                updateStats();
                addLogEntry(LOG_TYPES.WARNING, '点击了重置按钮', '将清空所有条目数据');
            });
            
            // 添加条目函数
            function addEntry(entry) {
                entries.push(entry);
                renderEntriesList();
                addLogEntry(LOG_TYPES.SUCCESS, '添加了新条目', `平台: ${entry.platform}, 账号: ${entry.accountType}`);
            }
            
            // 渲染条目列表
            function renderEntriesList() {
                entriesList.innerHTML = '';
                
                if (entries.length === 0) {
                    entriesList.innerHTML = '<div class="text-center p-5 text-muted fst-italic">暂无条目，请先在左侧添加条目</div>';
                    updateStats();
                    return;
                }
                
                entries.forEach((entry, index) => {
                    const entryItem = document.createElement('div');
                    entryItem.className = 'entry-item d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded';
                    entryItem.draggable = true;
                    entryItem.dataset.index = index;
                    
                    let displayText = entry.platform;
                    if (entry.accountType) displayText += `：${entry.accountType}`;
                    if (entry.passwordPattern) displayText += `：${entry.passwordPattern}`;
                    
                    entryItem.innerHTML = `
                        <div class="drag-handle me-2">≡</div>
                        <div class="entry-info flex-grow-1 text-truncate">${displayText}</div>
                        <div class="entry-actions">
                            <button class="btn btn-danger btn-sm">删除</button>
                        </div>
                    `;
                    
                    entriesList.appendChild(entryItem);
                    
                    // 添加删除事件
                    entryItem.querySelector('.btn-danger').addEventListener('click', function() {
                        const deletedEntry = entries[index];
                        entries.splice(index, 1);
                        renderEntriesList();
                        addLogEntry(LOG_TYPES.WARNING, '删除了条目', `平台: ${deletedEntry.platform}, 账号: ${deletedEntry.accountType}`);
                    });
                    
                    // 添加双击编辑事件
                    entryItem.addEventListener('dblclick', function() {
                        startEditEntry(index);
                        addLogEntry(LOG_TYPES.INFO, '开始编辑条目', `平台: ${entries[index].platform}, 账号: ${entries[index].accountType}`);
                    });
                    
                    // 添加拖拽事件
                    setupDragAndDrop(entryItem);
                });
                
                updateStats();
            }
            
            // 开始编辑条目
            function startEditEntry(index) {
                // 移除之前可能存在的编辑状态
                document.querySelectorAll('.entry-item.editing').forEach(item => {
                    item.classList.remove('editing');
                });
                
                // 设置当前编辑状态
                editingIndex = index;
                const entry = entries[index];
                
                // 填充编辑表单
                document.getElementById('editPlatform').value = entry.platform;
                document.getElementById('editAccountType').value = entry.accountType;
                document.getElementById('editPasswordPattern').value = entry.passwordPattern || '';
                
                // 显示编辑表单，隐藏添加表单
                editForm.classList.remove('d-none');
                entryForm.classList.add('d-none');
                
                // 高亮正在编辑的条目
                const entryItems = document.querySelectorAll('.entry-item');
                if (entryItems[index]) {
                    entryItems[index].classList.add('editing');
                }
            }
            
            // 设置拖拽功能
            function setupDragAndDrop(item) {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = item;
                    setTimeout(() => {
                        item.classList.add('dragging');
                    }, 0);
                });
                
                item.addEventListener('dragend', function() {
                    draggedItem = null;
                    item.classList.remove('dragging');
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                item.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '#e3f2fd';
                });
                
                item.addEventListener('dragleave', function() {
                    this.style.backgroundColor = '';
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '';
                    
                    if (draggedItem && draggedItem !== this) {
                        const fromIndex = parseInt(draggedItem.dataset.index);
                        const toIndex = parseInt(this.dataset.index);
                        
                        // 移动数组元素
                        const movedItem = entries.splice(fromIndex, 1)[0];
                        entries.splice(toIndex, 0, movedItem);
                        
                        // 重新渲染列表
                        renderEntriesList();
                        
                        // 记录拖拽操作
                        addLogEntry(LOG_TYPES.INFO, '拖拽移动了条目', `平台: ${movedItem.platform} 从位置 ${fromIndex + 1} 移动到位置 ${toIndex + 1}`);
                    }
                });
            }
            
            // 更新统计信息
            function updateStats() {
                const count = entries.length;
                listStats.textContent = `共 ${count} 个条目`;
            }
            
            // 生成下载内容
            function generateDownloadContent() {
                // 返回JSON格式内容
                return JSON.stringify(entries, null, 2);
            }
            
            // 下载文件函数
            function downloadFile(content, fileName, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                
                URL.revokeObjectURL(url);
            }
            
            // 初始化日志
            console.log('页面加载完成，按钮已绑定事件');
        });
    </script>
    
    <!-- 操作日志 offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="logOffcanvas" aria-labelledby="logOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="logOffcanvasLabel">操作日志</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted small">记录主要操作和错误信息</span>
                <button id="clearLogsBtn" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-trash me-1"></i>清空日志
                </button>
            </div>
            <div id="logContainer" class="mb-3">
                <div id="emptyLogMessage" class="text-center text-muted p-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>暂无操作记录</p>
                </div>
            </div>
            <div class="small text-muted">
                <i class="fas fa-info-circle me-1"></i>
                日志记录文件上传、下载、编辑等操作
            </div>
        </div>
    </div>
    
    <!-- PWA Service Worker注册 -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../../service-worker.js')
                    .then(registration => {
                        console.log('Service Worker 注册成功:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>
</html>